{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3 mb-4">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <h5 class="card-title">Fuel Inventory</h5>
                <h2 class="display-4" id="fuel-inventory">--</h2>
                <p class="card-text">Current total liters in stock</p>
                <div class="small mt-3" id="fuel-inventory-breakdown">
                    <!-- Fuel inventory breakdown by type -->
                </div>
            </div>
            <div class="card-footer d-flex align-items-center justify-content-between">
                <a class="small text-white stretched-link" href="/fuel">View Details</a>
                <div class="small text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <h5 class="card-title">Today's Sales</h5>
                <h2 class="display-4" id="today-sales">--</h2>
                <p class="card-text mb-2">Total sales amount today</p>
                <div class="d-flex flex-column gap-1 mt-2 small" id="today-sales-breakdown">
                    <!-- Today's sales breakdown by product -->
                </div>
            </div>
            <div class="card-footer d-flex align-items-center justify-content-between">
                <a class="small text-white stretched-link" href="/sales">View Details</a>
                <div class="small text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card bg-warning text-dark h-100">
            <div class="card-body">
                <h5 class="card-title">Staff Status</h5>
                <div class="d-flex justify-content-between align-items-baseline mb-2">
                    <div>
                        <h3 class="h2 mb-0" id="staff-count">--</h3>
                        <p class="small mb-0">On Duty</p>
                    </div>
                    <div class="text-end">
                        <h3 class="h2 mb-0" id="staff-off-duty">--</h3>
                        <p class="small mb-0">Off Duty</p>
                    </div>
                </div>
                <div class="progress mt-2 mb-2" style="height: 10px;">
                    <div class="progress-bar bg-success" id="staff-progress" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="small mt-2" id="staff-shifts">
                    <!-- Staff distribution by shift -->
                </div>
            </div>
            <div class="card-footer d-flex align-items-center justify-content-between">
                <a class="small text-dark stretched-link" href="/attendance">View Details</a>
                <div class="small text-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card bg-danger text-white h-100">
            <div class="card-body">
                <h5 class="card-title">Low Stock Alerts</h5>
                <h2 class="display-4" id="low-stock">--</h2>
                <p class="card-text">Tanks below 20% capacity</p>
                <div class="small mt-2" id="low-stock-details">
                    <!-- Low stock details -->
                </div>
            </div>
            <div class="card-footer d-flex align-items-center justify-content-between">
                <a class="small text-white stretched-link" href="/fuel">View Details</a>
                <div class="small text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Inventory Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2"><path d="M3 3v18h18"></path><path d="M18.4 9a9 9 0 0 0-6.4-2.9H12V9"></path><path d="M12 6.1a9 9 0 0 0-8.9 9v0"></path><path d="M7 19l5-5"></path></svg>
                    Product Inventory
                </h5>
                <button class="btn btn-sm btn-outline-primary" id="refresh-inventory-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                    Refresh
                </button>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="inventoryTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-inventory-tab" data-bs-toggle="tab" data-bs-target="#all-inventory" type="button" role="tab" aria-controls="all-inventory" aria-selected="true">All Products</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="fuel-inventory-tab" data-bs-toggle="tab" data-bs-target="#fuel-inventory-tab-content" type="button" role="tab" aria-controls="fuel-inventory-tab-content" aria-selected="false">Fuel Products</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="lubricants-tab" data-bs-toggle="tab" data-bs-target="#lubricants-content" type="button" role="tab" aria-controls="lubricants-content" aria-selected="false">Lubricants</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="accessories-tab" data-bs-toggle="tab" data-bs-target="#accessories-content" type="button" role="tab" aria-controls="accessories-content" aria-selected="false">Accessories</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="services-tab" data-bs-toggle="tab" data-bs-target="#services-content" type="button" role="tab" aria-controls="services-content" aria-selected="false">Services</button>
                    </li>
                </ul>
                
                <div class="tab-content mt-3" id="inventoryTabContent">
                    <!-- All Products Tab -->
                    <div class="tab-pane fade show active" id="all-inventory" role="tabpanel" aria-labelledby="all-inventory-tab">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="allProductsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Product ID</th>
                                        <th>Name</th>
                                        <th>Category</th>
                                        <th>Current Stock</th>
                                        <th>Unit</th>
                                        <th>Unit Price</th>
                                        <th>Value</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- All products will be loaded here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Fuel Products Tab -->
                    <div class="tab-pane fade" id="fuel-inventory-tab-content" role="tabpanel" aria-labelledby="fuel-inventory-tab">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="fuelProductsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Tank ID</th>
                                        <th>Fuel Type</th>
                                        <th>Current Level (L)</th>
                                        <th>Capacity (L)</th>
                                        <th>Level (%)</th>
                                        <th>Unit Price</th>
                                        <th>Value</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Fuel products will be loaded here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Lubricants Tab -->
                    <div class="tab-pane fade" id="lubricants-content" role="tabpanel" aria-labelledby="lubricants-tab">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="lubricantsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Product ID</th>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Current Stock</th>
                                        <th>Unit</th>
                                        <th>Unit Price</th>
                                        <th>Value</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Lubricants will be loaded here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Accessories Tab -->
                    <div class="tab-pane fade" id="accessories-content" role="tabpanel" aria-labelledby="accessories-tab">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="accessoriesTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Product ID</th>
                                        <th>Name</th>
                                        <th>Category</th>
                                        <th>Current Stock</th>
                                        <th>Unit</th>
                                        <th>Unit Price</th>
                                        <th>Value</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Accessories will be loaded here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Services Tab -->
                    <div class="tab-pane fade" id="services-content" role="tabpanel" aria-labelledby="services-tab">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="servicesTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Service ID</th>
                                        <th>Service Name</th>
                                        <th>Description</th>
                                        <th>Duration</th>
                                        <th>Price</th>
                                        <th>Availability</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Services will be loaded here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <span><strong>Total Products:</strong> <span id="total-product-count">0</span></span>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" id="print-inventory-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                            Print
                        </button>
                        <button class="btn btn-sm btn-outline-secondary me-2" id="export-inventory-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            Export
                        </button>
                        <a href="/inventory" class="btn btn-sm btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            Manage Inventory
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M11 3h9a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-9l-3 3V5z"></path><path d="M7 8h.01"></path><path d="M7 12h.01"></path><path d="M7 16h.01"></path></svg>
                    AI Insights (Previous Day)
                </span>
                <div>
                    <button class="btn btn-sm btn-outline-primary" id="ask-ai-btn" data-bs-toggle="modal" data-bs-target="#askAIModal">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><path d="M12 17h.01"></path></svg>
                        Ask Question
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="refresh-ai-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="ai-insights-content">
                    <div id="ai-loading" class="text-center py-5 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading AI insights...</span>
                        </div>
                        <p class="mt-2">Generating AI insights...</p>
                    </div>
                    <div id="ai-content">
                        <h5 class="card-title mb-3">Summary Report</h5>
                        <div class="ai-summary mb-3">
                            <p>Yesterday's operations showed a 3.5% increase in overall sales compared to the previous day, with Premium Unleaded fuel showing the strongest performance (+5.2%). Staff attendance was at 92%, with all shifts adequately covered.</p>
                        </div>
                        
                        <h6 class="card-subtitle mb-2 text-muted">Key Observations</h6>
                        <ul class="ai-observations mb-3">
                            <li>Fuel inventory levels are within optimal range, with no immediate replenishment required</li>
                            <li>Tank #2 (Diesel) usage decreased by 7% compared to weekly average</li>
                            <li>Maintenance expenses were 12% under budget for the period</li>
                            <li>Morning shift showed highest sales conversion rate (8.3%)</li>
                        </ul>
                        
                        <h6 class="card-subtitle mb-2 text-muted">Recommendations</h6>
                        <ul class="ai-recommendations">
                            <li>Consider scheduling delivery for Premium Unleaded within 3 days based on current consumption rate</li>
                            <li>Review pricing strategy for Diesel products to improve sales performance</li>
                            <li>Monitor Tank #3 sensor readings - fluctuations detected in afternoon readings</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="/reports" class="btn btn-sm btn-outline-primary">View Full Reports</a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M12 2C8 2 4 2.5 4 6v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6c0-3.5-4-4-8-4z"></path><path d="M20 6c0 1-1.8 3-8 3S4 7 4 6"></path><path d="M16 14c0 1-1.8 3-8 3s-8-2-8-3"></path><path d="M4 6v4c0 1.1 1.8 3 8 3s8-1.9 8-3V6"></path><path d="M4 14v4c0 1.1 1.8 3 8 3s8-1.9 8-3v-4"></path></svg>
                    Sales Trends (Last 7 Days)
                </span>
            </div>
            <div class="card-body">
                <canvas id="salesChart" width="100%" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M3 22h12"></path><path d="M8 6h7a2 2 0 0 1 2 2v10"></path><path d="M9 10v7"></path><path d="M13 10v7"></path><path d="M9 6V2"></path><path d="M12 6V2"></path></svg>
                    Tank Overview
                </span>
                <button class="btn btn-sm btn-outline-secondary" id="tank-details-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="tankTable">
                        <thead>
                            <tr>
                                <th>Tank ID</th>
                                <th>Fuel Type</th>
                                <th>Level (%)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Tank data will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                    Sales by Fuel Type
                </span>
            </div>
            <div class="card-body">
                <canvas id="fuelTypeChart" width="100%" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    Purchase Trends
                </span>
            </div>
            <div class="card-body">
                <canvas id="purchaseChart" width="100%" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M18 10h-4V4h4v6zm-6 0H8V4h4v6zM6 10H2V4h4v6zm12 8h-4v-6h4v6zm-6 0H8v-6h4v6zm-6 0H2v-6h4v6z"></path></svg>
                    Inventory Value Distribution
                </span>
            </div>
            <div class="card-body">
                <canvas id="inventoryValueChart" width="100%" height="50"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                    Recent Activities
                </span>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush" id="recent-activities">
                    <!-- Activities will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ask AI Modal -->
<div class="modal fade" id="askAIModal" tabindex="-1" aria-labelledby="askAIModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="askAIModalLabel">Ask AI Assistant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="ai-question-form">
                    <div class="mb-3">
                        <label for="ai-question" class="form-label">What would you like to know about your business?</label>
                        <textarea class="form-control" id="ai-question" rows="3" placeholder="e.g., What are the top selling products yesterday? How can I improve fuel sales?"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="ai-report-type" class="form-label">Report Type (Optional)</label>
                        <select class="form-select" id="ai-report-type">
                            <option value="">General Question</option>
                            <option value="fuel_consumption">Fuel Consumption Analysis</option>
                            <option value="sales_performance">Sales Performance Analysis</option>
                            <option value="inventory_management">Inventory Management Analysis</option>
                            <option value="staff_performance">Staff Performance Analysis</option>
                        </select>
                    </div>
                </form>
                <div id="ai-question-loading" class="text-center py-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Generating response...</span>
                    </div>
                    <p class="mt-2">Analyzing data and generating response...</p>
                </div>
                <div id="ai-question-result" class="mt-3 d-none">
                    <h6>AI Response:</h6>
                    <div class="card">
                        <div class="card-body" id="ai-response-content">
                            <!-- AI response will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="submit-ai-question">Submit Question</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fetch dashboard data
    fetch('/api/fuel/tanks')
        .then(response => response.json())
        .then(data => {
            // Update fuel inventory
            let totalFuel = 0;
            let lowStockCount = 0;
            const tankTableBody = document.querySelector('#tankTable tbody');
            tankTableBody.innerHTML = '';
            
            // Also update fuel products table
            const fuelProductsTableBody = document.querySelector('#fuelProductsTable tbody');
            if (fuelProductsTableBody) {
                fuelProductsTableBody.innerHTML = '';
            }
            
            data.forEach(tank => {
                totalFuel += tank.current_level;
                
                // Check for low stock
                const levelPercentage = (tank.current_level / tank.capacity) * 100;
                if (levelPercentage < 20) {
                    lowStockCount++;
                }
                
                // Add row to tank table
                const row = document.createElement('tr');
                const statusClass = tank.status === 'active' ? 'text-success' : 'text-danger';
                
                row.innerHTML = `
                    <td>${tank.id}</td>
                    <td>${tank.fuel_type}</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar ${levelPercentage < 20 ? 'bg-danger' : levelPercentage < 50 ? 'bg-warning' : 'bg-success'}" 
                                role="progressbar" style="width: ${levelPercentage}%" 
                                aria-valuenow="${levelPercentage}" aria-valuemin="0" aria-valuemax="100">
                                ${levelPercentage.toFixed(1)}%
                            </div>
                        </div>
                    </td>
                    <td class="${statusClass}">${tank.status}</td>
                `;
                tankTableBody.appendChild(row);
                
                // Add row to fuel products table (if it exists)
                if (fuelProductsTableBody) {
                    const unitPrice = getPriceByFuelType(tank.fuel_type);
                    const value = tank.current_level * unitPrice;
                    
                    const fuelRow = document.createElement('tr');
                    fuelRow.innerHTML = `
                        <td>${tank.id}</td>
                        <td>${tank.fuel_type}</td>
                        <td>${tank.current_level.toFixed(2)}</td>
                        <td>${tank.capacity.toFixed(2)}</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar ${levelPercentage < 20 ? 'bg-danger' : levelPercentage < 50 ? 'bg-warning' : 'bg-success'}" 
                                    role="progressbar" style="width: ${levelPercentage}%" 
                                    aria-valuenow="${levelPercentage}" aria-valuemin="0" aria-valuemax="100">
                                    ${levelPercentage.toFixed(1)}%
                                </div>
                            </div>
                        </td>
                        <td>$${unitPrice.toFixed(2)}/L</td>
                        <td>$${value.toFixed(2)}</td>
                        <td><span class="badge ${tank.status === 'active' ? 'bg-success' : 'bg-danger'}">${tank.status}</span></td>
                    `;
                    fuelProductsTableBody.appendChild(fuelRow);
                }
            });
            
            document.getElementById('fuel-inventory').textContent = totalFuel.toFixed(1);
            document.getElementById('low-stock').textContent = lowStockCount;
            
            // Update all product inventory if the table exists
            const allProductsTable = document.getElementById('allProductsTable');
            if (allProductsTable) {
                updateAllProductsTable(data);
            }
            
            // Initialize other product tables
            initializeProductTables();

            // Create fuel type pie chart
            const fuelTypes = {};
            data.forEach(tank => {
                if (fuelTypes[tank.fuel_type]) {
                    fuelTypes[tank.fuel_type] += tank.current_level;
                } else {
                    fuelTypes[tank.fuel_type] = tank.current_level;
                }
            });
            
            const fuelTypeCtx = document.getElementById('fuelTypeChart');
            if (fuelTypeCtx) {
                new Chart(fuelTypeCtx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(fuelTypes),
                        datasets: [{
                            data: Object.values(fuelTypes),
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)',
                                'rgba(255, 159, 64, 0.7)',
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            }
        });
    
    // Get today's sales with product breakdown
    fetch('/api/sales/sales/today')
        .then(response => response.json())
        .then(data => {
            let totalAmount = 0;
            
            // Group sales by product type
            const salesByProduct = {};
            
            data.forEach(sale => {
                totalAmount += sale.total_amount;
                
                // Group by fuel type
                if (!salesByProduct[sale.fuel_type]) {
                    salesByProduct[sale.fuel_type] = {
                        amount: 0,
                        volume: 0,
                        count: 0
                    };
                }
                
                salesByProduct[sale.fuel_type].amount += sale.total_amount;
                salesByProduct[sale.fuel_type].volume += sale.litres_sold;
                salesByProduct[sale.fuel_type].count += 1;
            });
            
            // Update total sales amount
            document.getElementById('today-sales').textContent = '\u20B9' + totalAmount.toFixed(2);
            
            // Update sales breakdown
            const salesBreakdownEl = document.getElementById('today-sales-breakdown');
            if (salesBreakdownEl) {
                let breakdownHtml = '';
                
                if (Object.keys(salesByProduct).length === 0) {
                    breakdownHtml = '<span class="text-muted">No sales recorded today</span>';
                } else {
                    for (const [product, stats] of Object.entries(salesByProduct)) {
                        breakdownHtml += `
                            <div class="d-flex justify-content-between align-items-center">
                                <span>${product}:</span>
                                <span>\u20B9${stats.amount.toFixed(2)} (${stats.volume.toFixed(1)}L)</span>
                            </div>
                        `;
                    }
                }
                
                salesBreakdownEl.innerHTML = breakdownHtml;
            }
            
            // Update fuel inventory breakdown too
            updateInventoryBreakdown();
        });
    
    // Get staff attendance and status
    Promise.all([
        fetch('/api/staff/attendance/today'),
        fetch('/api/staff/attendants')
    ])
        .then(responses => Promise.all(responses.map(r => r.json())))
        .then(([attendanceData, staffData]) => {
            // Count staff who have checked in but not checked out
            const onDutyCount = attendanceData.filter(record => record.check_in && !record.check_out).length;
            document.getElementById('staff-count').textContent = onDutyCount;
            
            // Count off-duty staff (total staff minus on-duty)
            const totalActiveStaff = staffData.filter(staff => staff.active).length;
            const offDutyCount = totalActiveStaff - onDutyCount;
            document.getElementById('staff-off-duty').textContent = offDutyCount;
            
            // Update progress bar
            const staffProgressBar = document.getElementById('staff-progress');
            if (staffProgressBar && totalActiveStaff > 0) {
                const onDutyPercentage = (onDutyCount / totalActiveStaff) * 100;
                staffProgressBar.style.width = onDutyPercentage + '%';
                staffProgressBar.setAttribute('aria-valuenow', onDutyPercentage);
            }
            
            // Group by shift
            const shiftsData = {};
            attendanceData.forEach(record => {
                if (record.shift) {
                    if (!shiftsData[record.shift]) {
                        shiftsData[record.shift] = 0;
                    }
                    if (record.check_in && !record.check_out) {
                        shiftsData[record.shift]++;
                    }
                }
            });
            
            // Update shift distribution
            const staffShiftsEl = document.getElementById('staff-shifts');
            if (staffShiftsEl) {
                let shiftsHtml = '';
                for (const [shift, count] of Object.entries(shiftsData)) {
                    shiftsHtml += `<div>${shift}: <strong>${count}</strong> staff</div>`;
                }
                staffShiftsEl.innerHTML = shiftsHtml || '<div>No shift data available</div>';
            }
        });
    
    // Create sales chart (using dummy data - will be replaced with actual API call)
    const salesCtx = document.getElementById('salesChart');
    if (salesCtx) {
        fetch('/api/sales/sales/summary?start_date=' + getDateStr(-7) + '&end_date=' + getDateStr(0))
            .then(response => response.json())
            .then(data => {
                // Process data for chart
                const dailyTotals = data.daily_totals || [];
                const labels = dailyTotals.map(item => {
                    // Format date
                    const date = new Date(item.date);
                    return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                });
                
                const salesData = dailyTotals.map(item => item.total_sales);
                const volumeData = dailyTotals.map(item => item.total_volume);
                
                new Chart(salesCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Sales Amount (\u20B9)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                data: salesData,
                                yAxisID: 'y',
                                tension: 0.1,
                                fill: true
                            },
                            {
                                label: 'Volume Sold (L)',
                                borderColor: 'rgba(153, 102, 255, 1)',
                                backgroundColor: 'rgba(153, 102, 255, 0.1)',
                                data: volumeData,
                                yAxisID: 'y1',
                                tension: 0.1,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Sales Amount (\u20B9)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: {
                                    drawOnChartArea: false,
                                },
                                title: {
                                    display: true,
                                    text: 'Volume (L)'
                                }
                            }
                        }
                    }
                });
            });
    }

    // Load recent activities
    Promise.all([
        fetch('/api/fuel/entries?limit=3'),
        fetch('/api/sales/sales?limit=3'),
        fetch('/api/staff/attendance?limit=3')
    ]).then(responses => Promise.all(responses.map(r => r.json())))
    .then(([fuelEntries, salesData, attendanceData]) => {
        const activities = [];
        
        // Add fuel entries
        if (fuelEntries.length) {
            fuelEntries.forEach(entry => {
                activities.push({
                    type: 'fuel',
                    message: `Tank ${entry.tank_id} received ${entry.litres_received} liters`,
                    time: new Date(entry.timestamp)
                });
            });
        }
        
        // Add sales
        if (salesData.length) {
            salesData.forEach(sale => {
                activities.push({
                    type: 'sale',
                    message: `${sale.litres_sold} liters of ${sale.fuel_type} sold for \u20B9${sale.total_amount}`,
                    time: new Date(sale.timestamp)
                });
            });
        }
        
        // Add attendance
        if (attendanceData.length) {
            attendanceData.forEach(record => {
                if (record.check_in && !record.check_out) {
                    activities.push({
                        type: 'attendance',
                        message: `Employee ${record.employee_id} checked in for ${record.shift} shift`,
                        time: new Date(record.check_in)
                    });
                } else if (record.check_out) {
                    activities.push({
                        type: 'attendance',
                        message: `Employee ${record.employee_id} checked out from ${record.shift} shift`,
                        time: new Date(record.check_out)
                    });
                }
            });
        }
        
        // Sort by time and take most recent
        activities.sort((a, b) => b.time - a.time);
        
        // Update activities list
        const activitiesList = document.getElementById('recent-activities');
        if (!activitiesList) return;
        
        activitiesList.innerHTML = '';
        
        if (activities.length === 0) {
            activitiesList.innerHTML = '<div class="list-group-item">No recent activities</div>';
            return;
        }
        
        activities.slice(0, 6).forEach(activity => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action';
            
            let iconClass = '';
            let icon = '';
            switch(activity.type) {
                case 'fuel':
                    iconClass = 'text-success';
                    icon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 22h12"></path><path d="M8 6h7a2 2 0 0 1 2 2v10"></path><path d="M9 10v7"></path><path d="M13 10v7"></path><path d="M9 6V2"></path><path d="M12 6V2"></path></svg>';
                    break;
                case 'sale':
                    iconClass = 'text-primary';
                    icon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 5H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zM2 10h20"></path></svg>';
                    break;
                case 'attendance':
                    iconClass = 'text-warning';
                    icon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>';
                    break;
            }
            
            // Format time
            const timeStr = formatTime(activity.time);
            
            item.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <p class="mb-1">
                        <span class="${iconClass} me-2">${icon}</span>
                        ${activity.message}
                    </p>
                    <small class="text-muted">${timeStr}</small>
                </div>
            `;
            
            activitiesList.appendChild(item);
        });
    });

    // Setup inventory tab event listeners
    setupInventoryTabs();
    
    // Setup refresh button
    const refreshBtn = document.getElementById('refresh-inventory-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            refreshInventoryData();
        });
    }
    
    // Setup print button
    const printBtn = document.getElementById('print-inventory-btn');
    if (printBtn) {
        printBtn.addEventListener('click', function() {
            window.print();
        });
    }
    
    // Setup export button
    const exportBtn = document.getElementById('export-inventory-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            exportInventoryData();
        });
    }
    
    // Initialize Purchase Trends
    initializePurchaseTrends();
    
    // Initialize Value Distribution
    initializeInventoryValueChart();
    
    // Set up AI refresh button
    const refreshAiBtn = document.getElementById('refresh-ai-btn');
    if (refreshAiBtn) {
        refreshAiBtn.addEventListener('click', function() {
            refreshAIInsights();
        });
    }
    
    // Set up AI question submit
    const submitAiBtn = document.getElementById('submit-ai-question');
    if (submitAiBtn) {
        submitAiBtn.addEventListener('click', function() {
            submitAIQuestion();
        });
    }
});

// Helper function to get a date string for n days from now
function getDateStr(daysOffset) {
    const date = new Date();
    date.setDate(date.getDate() + daysOffset);
    return date.toISOString().split('T')[0] + 'T00:00:00Z';
}

// Format time for display
function formatTime(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffMins < 60) {
        return diffMins + ' min ago';
    } else if (diffHours < 24) {
        return diffHours + ' hours ago';
    } else {
        return diffDays + ' days ago';
    }
}

// Helper function to get price by fuel type
function getPriceByFuelType(fuelType) {
    const prices = {
        'Regular Unleaded': 3.25,
        'Premium Unleaded': 3.85,
        'Diesel': 3.45,
        'Super Diesel': 3.95,
        'E85': 2.95
    };
    
    return prices[fuelType] || 3.50; // Default price if type not found
}

// Helper function to update All Products table
function updateAllProductsTable(fuelData) {
    const allProductsTable = document.getElementById('allProductsTable');
    if (!allProductsTable) return;
    
    const tbody = allProductsTable.querySelector('tbody');
    tbody.innerHTML = '';
    
    let totalProducts = 0;
    
    // Add fuel products
    fuelData.forEach(tank => {
        const unitPrice = getPriceByFuelType(tank.fuel_type);
        const value = tank.current_level * unitPrice;
        
        const levelPercentage = (tank.current_level / tank.capacity) * 100;
        const statusClass = tank.status === 'active' ? 'bg-success' : 'bg-danger';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>FUEL-${tank.id}</td>
            <td>${tank.fuel_type}</td>
            <td>Fuel</td>
            <td>${tank.current_level.toFixed(2)}</td>
            <td>Liters</td>
            <td>\u20B9${unitPrice.toFixed(2)}</td>
            <td>\u20B9${value.toFixed(2)}</td>
            <td><span class="badge ${statusClass}">${tank.status}</span></td>
        `;
        
        tbody.appendChild(row);
        totalProducts++;
    });
    
    // Add lubricants
    const lubricants = getLubricantsMockData();
    lubricants.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.id}</td>
            <td>${item.name}</td>
            <td>Lubricant</td>
            <td>${item.stock}</td>
            <td>${item.unit}</td>
            <td>\u20B9${item.price.toFixed(2)}</td>
            <td>\u20B9${(item.stock * item.price).toFixed(2)}</td>
            <td><span class="badge ${item.stock > 10 ? 'bg-success' : 'bg-warning'}">${item.stock > 5 ? 'In Stock' : 'Low Stock'}</span></td>
        `;
        
        tbody.appendChild(row);
        totalProducts++;
    });
    
    // Add accessories
    const accessories = getAccessoriesMockData();
    accessories.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.id}</td>
            <td>${item.name}</td>
            <td>Accessory</td>
            <td>${item.stock}</td>
            <td>${item.unit}</td>
            <td>\u20B9${item.price.toFixed(2)}</td>
            <td>\u20B9${(item.stock * item.price).toFixed(2)}</td>
            <td><span class="badge ${item.stock > 10 ? 'bg-success' : 'bg-warning'}">${item.stock > 5 ? 'In Stock' : 'Low Stock'}</span></td>
        `;
        
        tbody.appendChild(row);
        totalProducts++;
    });
    
    // Update total product count
    const totalCountEl = document.getElementById('total-product-count');
    if (totalCountEl) {
        totalCountEl.textContent = totalProducts;
    }
}

// Initialize all product inventory tables
function initializeProductTables() {
    // Load lubricants
    loadLubricantsTable();
    
    // Load accessories
    loadAccessoriesTable();
    
    // Load services
    loadServicesTable();
}

// Setup inventory tab event handlers
function setupInventoryTabs() {
    const tabButtons = document.querySelectorAll('#inventoryTabs button');
    if (!tabButtons.length) return;
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-bs-target').substring(1);
            
            switch(targetId) {
                case 'lubricants-content':
                    loadLubricantsTable();
                    break;
                case 'accessories-content':
                    loadAccessoriesTable();
                    break;
                case 'services-content':
                    loadServicesTable();
                    break;
            }
        });
    });
}

// Helper function to load lubricants table
function loadLubricantsTable() {
    const lubricantsTable = document.getElementById('lubricantsTable');
    if (!lubricantsTable) return;
    
    const tbody = lubricantsTable.querySelector('tbody');
    tbody.innerHTML = '';
    
    // Load mock data for now
    const lubricants = getLubricantsMockData();
    
    lubricants.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.id}</td>
            <td>${item.name}</td>
            <td>${item.type}</td>
            <td>${item.stock}</td>
            <td>${item.unit}</td>
            <td>\u20B9${item.price.toFixed(2)}</td>
            <td>\u20B9${(item.stock * item.price).toFixed(2)}</td>
            <td><span class="badge ${item.stock > 10 ? 'bg-success' : 'bg-warning'}">${item.stock > 5 ? 'In Stock' : 'Low Stock'}</span></td>
        `;
        
        tbody.appendChild(row);
    });
}

// Helper function to load accessories table
function loadAccessoriesTable() {
    const accessoriesTable = document.getElementById('accessoriesTable');
    if (!accessoriesTable) return;
    
    const tbody = accessoriesTable.querySelector('tbody');
    tbody.innerHTML = '';
    
    // Load mock data for now
    const accessories = getAccessoriesMockData();
    
    accessories.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.id}</td>
            <td>${item.name}</td>
            <td>${item.category}</td>
            <td>${item.stock}</td>
            <td>${item.unit}</td>
            <td>\u20B9${item.price.toFixed(2)}</td>
            <td>\u20B9${(item.stock * item.price).toFixed(2)}</td>
            <td><span class="badge ${item.stock > 10 ? 'bg-success' : 'bg-warning'}">${item.stock > 5 ? 'In Stock' : 'Low Stock'}</span></td>
        `;
        
        tbody.appendChild(row);
    });
}

// Helper function to load services table
function loadServicesTable() {
    const servicesTable = document.getElementById('servicesTable');
    if (!servicesTable) return;
    
    const tbody = servicesTable.querySelector('tbody');
    tbody.innerHTML = '';
    
    // Example services
    const services = [
        { id: 'SRV-001', name: 'Express Car Wash', description: 'Quick exterior car wash', duration: '15 min', price: 12.99, available: true },
        { id: 'SRV-002', name: 'Full Car Wash', description: 'Complete interior and exterior wash', duration: '30 min', price: 24.99, available: true },
        { id: 'SRV-003', name: 'Oil Change', description: 'Standard oil change service', duration: '45 min', price: 35.99, available: true },
        { id: 'SRV-004', name: 'Tire Pressure Check', description: 'Check and adjust tire pressure', duration: '10 min', price: 5.99, available: true },
        { id: 'SRV-005', name: 'Vehicle Inspection', description: 'Basic vehicle safety inspection', duration: '20 min', price: 19.99, available: false }
    ];
    
    services.forEach(service => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${service.id}</td>
            <td>${service.name}</td>
            <td>${service.description}</td>
            <td>${service.duration}</td>
            <td>\u20B9${service.price.toFixed(2)}</td>
            <td><span class="badge ${service.available ? 'bg-success' : 'bg-danger'}">${service.available ? 'Available' : 'Unavailable'}</span></td>
        `;
        
        tbody.appendChild(row);
    });
}

// Helper function to refresh inventory data
function refreshInventoryData() {
    // Show a loading toast
    showToast('Refreshing inventory data...', 'info');
    
    // Re-fetch data
    fetch('/api/fuel/tanks')
        .then(response => response.json())
        .then(data => {
            // Update tables with new data
            updateAllProductsTable(data);
            
            // Also update individual product tables
            initializeProductTables();
            
            // Show success message
            showToast('Inventory data refreshed successfully!', 'success');
        })
        .catch(error => {
            console.error('Error refreshing inventory:', error);
            showToast('Error refreshing inventory data', 'danger');
        });
}

// Helper function to export inventory data
function exportInventoryData() {
    // Show a loading toast
    showToast('Preparing inventory data export...', 'info');
    
    // Simulate a delay for export generation
    setTimeout(() => {
        showToast('Inventory data exported successfully!', 'success');
    }, 1500);
}

// Helper function to show toast notifications
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toastEl = document.createElement('div');
    toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    
    toastEl.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    // Add toast to container
    toastContainer.appendChild(toastEl);
    
    // Initialize and show toast
    const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
    toast.show();
    
    // Remove toast after it's hidden
    toastEl.addEventListener('hidden.bs.toast', function() {
        toastEl.remove();
    });
}

// Mock data functions for demonstration purposes
function getLubricantsMockData() {
    return [
        { id: 'LUB-001', name: 'Premium Engine Oil', type: 'Engine Oil', stock: 45, unit: 'Liters', price: 8.99 },
        { id: 'LUB-002', name: 'Synthetic Oil', type: 'Engine Oil', stock: 32, unit: 'Liters', price: 12.99 },
        { id: 'LUB-003', name: 'Transmission Fluid', type: 'Transmission', stock: 18, unit: 'Liters', price: 9.49 },
        { id: 'LUB-004', name: 'Brake Fluid', type: 'Brake System', stock: 25, unit: 'Liters', price: 7.99 },
        { id: 'LUB-005', name: 'Power Steering Fluid', type: 'Steering', stock: 12, unit: 'Liters', price: 6.99 },
        { id: 'LUB-006', name: 'Coolant/Antifreeze', type: 'Cooling System', stock: 28, unit: 'Liters', price: 5.49 },
        { id: 'LUB-007', name: 'Motorcycle Oil', type: 'Specialty', stock: 15, unit: 'Liters', price: 11.99 }
    ];
}

function getAccessoriesMockData() {
    return [
        { id: 'ACC-001', name: 'Air Freshener', category: 'Interior', stock: 78, unit: 'Pieces', price: 2.99 },
        { id: 'ACC-002', name: 'Phone Holder', category: 'Interior', stock: 35, unit: 'Pieces', price: 14.99 },
        { id: 'ACC-003', name: 'Car Vacuum Cleaner', category: 'Cleaning', stock: 8, unit: 'Pieces', price: 39.99 },
        { id: 'ACC-004', name: 'Windshield Wiper Blades', category: 'Exterior', stock: 42, unit: 'Pairs', price: 22.99 },
        { id: 'ACC-005', name: 'Floor Mats', category: 'Interior', stock: 15, unit: 'Sets', price: 29.99 },
        { id: 'ACC-006', name: 'Car Wash Soap', category: 'Cleaning', stock: 25, unit: 'Bottles', price: 8.49 },
        { id: 'ACC-007', name: 'Tire Inflator', category: 'Tools', stock: 7, unit: 'Pieces', price: 45.99 },
        { id: 'ACC-008', name: 'First Aid Kit', category: 'Safety', stock: 18, unit: 'Kits', price: 12.99 }
    ];
}

// Function to update the fuel inventory breakdown
function updateInventoryBreakdown() {
    // Fetch current tank data
    fetch('/api/fuel/tanks')
        .then(response => response.json())
        .then(data => {
            // Group by fuel type
            const fuelTypes = {};
            let totalVolume = 0;
            
            data.forEach(tank => {
                if (!fuelTypes[tank.fuel_type]) {
                    fuelTypes[tank.fuel_type] = 0;
                }
                fuelTypes[tank.fuel_type] += tank.current_level;
                totalVolume += tank.current_level;
            });
            
            // Update the breakdown in the dashboard card
            const breakdownEl = document.getElementById('fuel-inventory-breakdown');
            if (breakdownEl) {
                let breakdownHtml = '';
                
                if (Object.keys(fuelTypes).length === 0) {
                    breakdownHtml = '<span class="text-muted">No fuel inventory data</span>';
                } else {
                    for (const [fuelType, volume] of Object.entries(fuelTypes)) {
                        const percentage = ((volume / totalVolume) * 100).toFixed(1);
                        breakdownHtml += `
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span>${fuelType}:</span>
                                <span>${volume.toFixed(1)}L (${percentage}%)</span>
                            </div>
                        `;
                    }
                }
                
                breakdownEl.innerHTML = breakdownHtml;
            }
            
            // Update low stock details
            updateLowStockDetails(data);
        });
}

// Function to update low stock details
function updateLowStockDetails(data) {
    const lowStockDetailsEl = document.getElementById('low-stock-details');
    if (!lowStockDetailsEl) return;
    
    const lowStockTanks = data.filter(tank => {
        const levelPercentage = (tank.current_level / tank.capacity) * 100;
        return levelPercentage < 20;
    });
    
    if (lowStockTanks.length === 0) {
        lowStockDetailsEl.innerHTML = '<span class="text-success">All tanks have adequate fuel levels</span>';
        return;
    }
    
    let detailsHtml = '';
    lowStockTanks.forEach(tank => {
        const levelPercentage = (tank.current_level / tank.capacity) * 100;
        detailsHtml += `
            <div class="text-danger mb-1">Tank ${tank.id} (${tank.fuel_type}): ${levelPercentage.toFixed(1)}%</div>
        `;
    });
    
    lowStockDetailsEl.innerHTML = detailsHtml;
}

// Function to initialize purchase trends chart
function initializePurchaseTrends() {
    const purchaseChartCtx = document.getElementById('purchaseChart');
    if (!purchaseChartCtx) return;
    
    // Simulate purchase data for the last 5 days
    const days = 5;
    const labels = [];
    const regularData = [];
    const premiumData = [];
    const dieselData = [];
    
    for (let i = days - 1; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
        
        // Generate sample data for demonstration
        regularData.push(Math.floor(Math.random() * 500) + 1000);  // 1000-1500 liters
        premiumData.push(Math.floor(Math.random() * 300) + 500);   // 500-800 liters
        dieselData.push(Math.floor(Math.random() * 400) + 700);    // 700-1100 liters
    }
    
    new Chart(purchaseChartCtx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Regular Unleaded',
                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                    data: regularData,
                    stack: 'stack1'
                },
                {
                    label: 'Premium Unleaded',
                    backgroundColor: 'rgba(153, 102, 255, 0.7)',
                    data: premiumData,
                    stack: 'stack1'
                },
                {
                    label: 'Diesel',
                    backgroundColor: 'rgba(255, 159, 64, 0.7)',
                    data: dieselData,
                    stack: 'stack1'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Daily Fuel Purchases (Liters)'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Day'
                    }
                },
                y: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Volume (L)'
                    }
                }
            }
        }
    });
}

// Function to initialize inventory value distribution chart
function initializeInventoryValueChart() {
    const valueChartCtx = document.getElementById('inventoryValueChart');
    if (!valueChartCtx) return;
    
    // Get all inventory data
    Promise.all([
        fetch('/api/fuel/tanks'),
        // In the future, you might add API endpoints for lubricants, accessories, etc.
    ])
    .then(responses => Promise.all(responses.map(r => r.json())))
    .then(([fuelData]) => {
        // Calculate fuel value
        let fuelValue = 0;
        fuelData.forEach(tank => {
            const price = getPriceByFuelType(tank.fuel_type);
            fuelValue += tank.current_level * price;
        });
        
        // Get values for other product categories
        const lubricants = getLubricantsMockData();
        const accessories = getAccessoriesMockData();
        
        let lubricantsValue = 0;
        lubricants.forEach(item => {
            lubricantsValue += item.stock * item.price;
        });
        
        let accessoriesValue = 0;
        accessories.forEach(item => {
            accessoriesValue += item.stock * item.price;
        });
        
        // Create the chart
        new Chart(valueChartCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Fuel Products', 'Lubricants', 'Accessories'],
                datasets: [{
                    data: [fuelValue, lubricantsValue, accessoriesValue],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    title: {
                        display: true,
                        text: 'Inventory Value Distribution (\u20B9)'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                const value = context.raw;
                                label += '\u20B9' + value.toFixed(2);
                                return label;
                            }
                        }
                    }
                }
            }
        });
    });
}

// Function to refresh AI insights
function refreshAIInsights() {
    const aiContentEl = document.getElementById('ai-content');
    const aiLoadingEl = document.getElementById('ai-loading');
    
    if (!aiContentEl || !aiLoadingEl) return;
    
    // Show loading indicator
    aiContentEl.classList.add('d-none');
    aiLoadingEl.classList.remove('d-none');
    
    // In a real implementation, you would fetch from your AI reports API
    // For demonstration, simulate a delay
    setTimeout(() => {
        // Hide loading indicator
        aiLoadingEl.classList.add('d-none');
        aiContentEl.classList.remove('d-none');
        
        // Show updated content (this would be the API response in a real implementation)
        showToast('AI insights refreshed successfully!', 'success');
    }, 2000);
}

// Function to submit an AI question
function submitAIQuestion() {
    const questionInput = document.getElementById('ai-question');
    const reportTypeSelect = document.getElementById('ai-report-type');
    const loadingEl = document.getElementById('ai-question-loading');
    const resultEl = document.getElementById('ai-question-result');
    const responseContentEl = document.getElementById('ai-response-content');
    
    if (!questionInput || !reportTypeSelect || !loadingEl || !resultEl || !responseContentEl) return;
    
    const question = questionInput.value.trim();
    const reportType = reportTypeSelect.value;
    
    if (!question) {
        showToast('Please enter a question', 'warning');
        return;
    }
    
    // Show loading state
    loadingEl.classList.remove('d-none');
    resultEl.classList.add('d-none');
    
    // Prepare the request data
    const requestData = {
        prompt: question,
        report_type: reportType || null,
        start_date: getDateStr(-7),  // Last 7 days
        end_date: getDateStr(0)      // Today
    };
    
    // In a real implementation, this would be an API call to your AI reports endpoint
    // For demonstration, simulate a delay
    setTimeout(() => {
        // Hide loading
        loadingEl.classList.add('d-none');
        resultEl.classList.remove('d-none');
        
        // Show sample response (this would be the API response in a real implementation)
        responseContentEl.innerHTML = `
            <h6>Analysis Based on Your Question:</h6>
            <p>${question}</p>
            <hr>
            <p>Based on the data from the last 7 days, I can provide the following insights:</p>
            <ul>
                <li>Regular Unleaded fuel sales have increased by 4.2% compared to the previous week</li>
                <li>Morning shift (6 AM - 2 PM) shows the highest sales conversion at 8.5%</li>
                <li>Peak sales hours are between 7-9 AM and 4-6 PM</li>
                <li>Customer loyalty program participation has improved by 6.3%</li>
            </ul>
            <p><strong>Recommendation:</strong> Consider running a promotion for Premium Unleaded during evening hours to boost sales in that category, which is currently underperforming by 2.8% compared to target.</p>
        `;
    }, 2500);
}
</script>
{% endblock %}
{% extends "layout.html" %}

{% block title %}Products Management{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1 class="mb-4">Products Management</h1>
    
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Product Categories</h5>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                        <i class="fa fa-plus"></i> Add Category
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="categories-table-body">
                                <!-- Categories will be loaded here via JavaScript -->
                                <tr>
                                    <td colspan="3" class="text-center">Loading categories...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Category Management</h5>
                </div>
                <div class="card-body">
                    <p>Categories help you organize your products for easier inventory management and reporting.</p>
                    <p><strong>Examples of categories:</strong></p>
                    <ul>
                        <li>Fuels (Petrol, Diesel, etc.)</li>
                        <li>Lubricants (Engine oil, Gear oil, etc.)</li>
                        <li>Car Accessories</li>
                        <li>Convenience Store Items</li>
                    </ul>
                    <p>You can add, edit, or delete categories as needed. Each product must belong to a category.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Products</h5>
                    <div>
                        <button class="btn btn-sm btn-secondary me-2" id="refreshProductsBtn">
                            <i class="fa fa-refresh"></i> Refresh
                        </button>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                            <i class="fa fa-plus"></i> Add Product
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select id="category-filter" class="form-select">
                                <option value="">All Categories</option>
                                <!-- Categories will be loaded here -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="status-filter" class="form-select">
                                <option value="">All Status</option>
                                <option value="active" selected>Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" id="search-input" class="form-control" placeholder="Search products...">
                                <button class="btn btn-outline-secondary" type="button" id="search-btn">
                                    <i class="fa fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Unit Price</th>
                                    <th>Stock Quantity</th>
                                    <th>UOM</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body">
                                <!-- Products will be loaded here via JavaScript -->
                                <tr>
                                    <td colspan="8" class="text-center">Loading products...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalLabel">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <div class="mb-3">
                        <label for="category-id" class="form-label">Category ID</label>
                        <input type="text" class="form-control" id="category-id" required>
                        <div class="form-text">A unique identifier for the category (e.g., FUEL, LUBE)</div>
                    </div>
                    <div class="mb-3">
                        <label for="category-name" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="category-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="category-description" class="form-label">Description</label>
                        <textarea class="form-control" id="category-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="category-branch" class="form-label">Branch</label>
                        <select class="form-select" id="category-branch" required>
                            <!-- Branches will be loaded here -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCategoryBtn">Save Category</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCategoryModalLabel">Edit Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCategoryForm">
                    <input type="hidden" id="edit-category-id">
                    <div class="mb-3">
                        <label for="edit-category-name" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="edit-category-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-category-description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit-category-description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger me-auto" id="deleteCategoryBtn">Delete</button>
                <button type="button" class="btn btn-primary" id="updateCategoryBtn">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="product-id" class="form-label">Product ID</label>
                                <input type="text" class="form-control" id="product-id" required>
                                <div class="form-text">A unique identifier for the product</div>
                            </div>
                            <div class="mb-3">
                                <label for="product-name" class="form-label">Product Name</label>
                                <input type="text" class="form-control" id="product-name" required>
                            </div>
                            <div class="mb-3">
                                <label for="product-category" class="form-label">Category</label>
                                <select class="form-select" id="product-category" required>
                                    <!-- Categories will be loaded here -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="product-description" class="form-label">Description</label>
                                <textarea class="form-control" id="product-description" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="product-unit-price" class="form-label">Unit Price</label>
                                <input type="number" class="form-control" id="product-unit-price" required step="0.01" min="0">
                            </div>
                            <div class="mb-3">
                                <label for="product-cost-price" class="form-label">Cost Price (Optional)</label>
                                <input type="number" class="form-control" id="product-cost-price" step="0.01" min="0">
                            </div>
                            <div class="mb-3">
                                <label for="product-stock-quantity" class="form-label">Initial Stock Quantity</label>
                                <input type="number" class="form-control" id="product-stock-quantity" required value="0" min="0">
                            </div>
                            <div class="mb-3">
                                <label for="product-minimum-stock" class="form-label">Minimum Stock Level (Optional)</label>
                                <input type="number" class="form-control" id="product-minimum-stock" min="0">
                                <div class="form-text">System will alert when stock falls below this level</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="product-uom" class="form-label">Unit of Measure</label>
                                <select class="form-select" id="product-uom" required>
                                    <option value="liters">Liters</option>
                                    <option value="pieces">Pieces</option>
                                    <option value="bottles">Bottles</option>
                                    <option value="boxes">Boxes</option>
                                    <option value="kg">Kilograms</option>
                                    <option value="each">Each</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="product-is-fuel" class="form-label">Is Fuel?</label>
                                <select class="form-select" id="product-is-fuel" required>
                                    <option value="false" selected>No</option>
                                    <option value="true">Yes</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="product-branch" class="form-label">Branch</label>
                                <select class="form-select" id="product-branch" required>
                                    <!-- Branches will be loaded here -->
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="product-barcode" class="form-label">Barcode (Optional)</label>
                                <input type="text" class="form-control" id="product-barcode">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="product-image-url" class="form-label">Image URL (Optional)</label>
                                <input type="text" class="form-control" id="product-image-url">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveProductBtn">Save Product</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProductModalLabel">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" id="edit-product-id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-product-name" class="form-label">Product Name</label>
                                <input type="text" class="form-control" id="edit-product-name" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-product-category" class="form-label">Category</label>
                                <select class="form-select" id="edit-product-category" required>
                                    <!-- Categories will be loaded here -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="edit-product-description" class="form-label">Description</label>
                                <textarea class="form-control" id="edit-product-description" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-product-unit-price" class="form-label">Unit Price</label>
                                <input type="number" class="form-control" id="edit-product-unit-price" required step="0.01" min="0">
                            </div>
                            <div class="mb-3">
                                <label for="edit-product-cost-price" class="form-label">Cost Price (Optional)</label>
                                <input type="number" class="form-control" id="edit-product-cost-price" step="0.01" min="0">
                            </div>
                            <div class="mb-3">
                                <label for="edit-product-stock-quantity" class="form-label">Current Stock Quantity</label>
                                <input type="number" class="form-control" id="edit-product-stock-quantity" required min="0">
                            </div>
                            <div class="mb-3">
                                <label for="edit-product-minimum-stock" class="form-label">Minimum Stock Level (Optional)</label>
                                <input type="number" class="form-control" id="edit-product-minimum-stock" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit-product-uom" class="form-label">Unit of Measure</label>
                                <select class="form-select" id="edit-product-uom" required>
                                    <option value="liters">Liters</option>
                                    <option value="pieces">Pieces</option>
                                    <option value="bottles">Bottles</option>
                                    <option value="boxes">Boxes</option>
                                    <option value="kg">Kilograms</option>
                                    <option value="each">Each</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit-product-is-fuel" class="form-label">Is Fuel?</label>
                                <select class="form-select" id="edit-product-is-fuel" required>
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit-product-status" class="form-label">Status</label>
                                <select class="form-select" id="edit-product-status" required>
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-product-barcode" class="form-label">Barcode (Optional)</label>
                                <input type="text" class="form-control" id="edit-product-barcode">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-product-image-url" class="form-label">Image URL (Optional)</label>
                                <input type="text" class="form-control" id="edit-product-image-url">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger me-auto" id="deleteProductBtn">Delete</button>
                <button type="button" class="btn btn-primary" id="updateProductBtn">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Adjust Stock Modal -->
<div class="modal fade" id="adjustStockModal" tabindex="-1" aria-labelledby="adjustStockModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adjustStockModalLabel">Adjust Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="adjustStockForm">
                    <input type="hidden" id="adjust-product-id">
                    <div class="mb-3">
                        <label class="form-label">Product</label>
                        <div class="form-control" id="adjust-product-name" readonly></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Current Stock</label>
                        <div class="form-control" id="adjust-current-stock" readonly></div>
                    </div>
                    <div class="mb-3">
                        <label for="adjust-quantity" class="form-label">Adjustment Quantity</label>
                        <input type="number" class="form-control" id="adjust-quantity" required min="0">
                        <div class="form-text">Use positive number for stock addition, negative for reduction</div>
                    </div>
                    <div class="mb-3">
                        <label for="adjust-reason" class="form-label">Transaction Type</label>
                        <select class="form-select" id="adjust-reason" required>
                            <option value="">Select reason</option>
                            <option value="purchase">Purchase</option>
                            <option value="sale">Sale</option>
                            <option value="return">Return</option>
                            <option value="damaged">Damaged/Loss</option>
                            <option value="adjustment">Inventory Adjustment</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="adjust-reference" class="form-label">Reference (Optional)</label>
                        <input type="text" class="form-control" id="adjust-reference">
                        <div class="form-text">E.g., Invoice number, Sale ID, etc.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveStockAdjustBtn">Save Adjustment</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load branches for dropdowns
    loadBranches();
    
    // Load categories
    loadCategories();
    
    // Load products
    loadProducts();
    
    // Set up event listeners
    document.getElementById('saveCategoryBtn').addEventListener('click', saveCategory);
    document.getElementById('updateCategoryBtn').addEventListener('click', updateCategory);
    document.getElementById('deleteCategoryBtn').addEventListener('click', deleteCategory);
    document.getElementById('saveProductBtn').addEventListener('click', saveProduct);
    document.getElementById('updateProductBtn').addEventListener('click', updateProduct);
    document.getElementById('deleteProductBtn').addEventListener('click', deleteProduct);
    document.getElementById('saveStockAdjustBtn').addEventListener('click', adjustStock);
    document.getElementById('refreshProductsBtn').addEventListener('click', loadProducts);
    document.getElementById('search-btn').addEventListener('click', loadProducts);
    document.getElementById('category-filter').addEventListener('change', loadProducts);
    document.getElementById('status-filter').addEventListener('change', loadProducts);
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            loadProducts();
        }
    });
});

function loadBranches() {
    fetch('/api/branch/branches')
        .then(response => response.json())
        .then(branches => {
            const branchSelects = document.querySelectorAll('#category-branch, #product-branch');
            branchSelects.forEach(select => {
                select.innerHTML = '';
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id;
                    option.textContent = branch.name;
                    select.appendChild(option);
                });
            });
        })
        .catch(error => {
            console.error('Error loading branches:', error);
            showToast('Error loading branches. Please refresh the page.', 'danger');
        });
}

function loadCategories() {
    fetch('/api/products/categories')
        .then(response => response.json())
        .then(categories => {
            // Populate categories table
            const tableBody = document.getElementById('categories-table-body');
            tableBody.innerHTML = '';
            
            if (categories.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center">No categories found</td></tr>';
                return;
            }
            
            categories.forEach(category => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category.name}</td>
                    <td>${category.description || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editCategory('${category.id}')">
                            <i class="fa fa-edit"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Populate category filter dropdown
            const categoryFilter = document.getElementById('category-filter');
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categoryFilter.appendChild(option);
            });
            
            // Populate category dropdowns in product forms
            const categorySelects = document.querySelectorAll('#product-category, #edit-product-category');
            categorySelects.forEach(select => {
                select.innerHTML = '';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    select.appendChild(option);
                });
            });
        })
        .catch(error => {
            console.error('Error loading categories:', error);
            document.getElementById('categories-table-body').innerHTML = 
                '<tr><td colspan="3" class="text-center text-danger">Error loading categories</td></tr>';
        });
}

function loadProducts() {
    const categoryId = document.getElementById('category-filter').value;
    const isActive = document.getElementById('status-filter').value;
    const search = document.getElementById('search-input').value;
    
    let url = '/api/products/products?';
    if (categoryId) url += `category_id=${categoryId}&`;
    if (isActive === 'active') url += 'is_active=true&';
    if (isActive === 'inactive') url += 'is_active=false&';
    if (search) url += `search=${encodeURIComponent(search)}&`;
    
    fetch(url)
        .then(response => response.json())
        .then(products => {
            const tableBody = document.getElementById('products-table-body');
            tableBody.innerHTML = '';
            
            if (products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No products found</td></tr>';
                return;
            }
            
            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.id}</td>
                    <td>${product.name}</td>
                    <td>${product.category_name || 'Unknown'}</td>
                    <td>${product.unit_price.toFixed(2)}</td>
                    <td>${product.stock_quantity} ${product.unit_of_measure}</td>
                    <td>${product.unit_of_measure}</td>
                    <td><span class="badge ${product.is_active ? 'bg-success' : 'bg-danger'}">
                        ${product.is_active ? 'Active' : 'Inactive'}
                    </span></td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editProduct('${product.id}')">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="adjustStockModal('${product.id}')">
                                <i class="fa fa-cubes"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error loading products:', error);
            document.getElementById('products-table-body').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Error loading products</td></tr>';
        });
}

function saveCategory() {
    const categoryData = {
        id: document.getElementById('category-id').value,
        name: document.getElementById('category-name').value,
        description: document.getElementById('category-description').value,
        branch_id: document.getElementById('category-branch').value
    };
    
    fetch('/api/products/categories', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(categoryData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        showToast('Category added successfully', 'success');
        document.getElementById('addCategoryForm').reset();
        const modal = bootstrap.Modal.getInstance(document.getElementById('addCategoryModal'));
        modal.hide();
        loadCategories();
    })
    .catch(error => {
        console.error('Error adding category:', error);
        showToast(error.message || 'Failed to add category', 'danger');
    });
}

function editCategory(categoryId) {
    fetch(`/api/products/categories/${categoryId}`)
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(category => {
            document.getElementById('edit-category-id').value = category.id;
            document.getElementById('edit-category-name').value = category.name;
            document.getElementById('edit-category-description').value = category.description || '';
            
            const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error fetching category:', error);
            showToast(error.message || 'Failed to fetch category details', 'danger');
        });
}

function updateCategory() {
    const categoryId = document.getElementById('edit-category-id').value;
    const updates = {
        name: document.getElementById('edit-category-name').value,
        description: document.getElementById('edit-category-description').value
    };
    
    fetch(`/api/products/categories/${categoryId}`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updates)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        showToast('Category updated successfully', 'success');
        const modal = bootstrap.Modal.getInstance(document.getElementById('editCategoryModal'));
        modal.hide();
        loadCategories();
    })
    .catch(error => {
        console.error('Error updating category:', error);
        showToast(error.message || 'Failed to update category', 'danger');
    });
}

function deleteCategory() {
    if (!confirm('Are you sure you want to delete this category? All products in this category will be orphaned!')) {
        return;
    }
    
    const categoryId = document.getElementById('edit-category-id').value;
    
    fetch(`/api/products/categories/${categoryId}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        showToast('Category deleted successfully', 'success');
        const modal = bootstrap.Modal.getInstance(document.getElementById('editCategoryModal'));
        modal.hide();
        loadCategories();
        loadProducts(); // Reload products as some might be affected
    })
    .catch(error => {
        console.error('Error deleting category:', error);
        showToast(error.message || 'Failed to delete category', 'danger');
    });
}

function saveProduct() {
    const productData = {
        id: document.getElementById('product-id').value,
        name: document.getElementById('product-name').value,
        category_id: document.getElementById('product-category').value,
        description: document.getElementById('product-description').value,
        unit_price: parseFloat(document.getElementById('product-unit-price').value),
        cost_price: document.getElementById('product-cost-price').value ? 
            parseFloat(document.getElementById('product-cost-price').value) : null,
        stock_quantity: parseFloat(document.getElementById('product-stock-quantity').value),
        minimum_stock_level: document.getElementById('product-minimum-stock').value ? 
            parseFloat(document.getElementById('product-minimum-stock').value) : null,
        unit_of_measure: document.getElementById('product-uom').value,
        is_fuel: document.getElementById('product-is-fuel').value === 'true',
        barcode: document.getElementById('product-barcode').value || null,
        image_url: document.getElementById('product-image-url').value || null,
        branch_id: document.getElementById('product-branch').value
    };
    
    fetch('/api/products/products', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(productData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        showToast('Product added successfully', 'success');
        document.getElementById('addProductForm').reset();
        const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
        modal.hide();
        loadProducts();
    })
    .catch(error => {
        console.error('Error adding product:', error);
        showToast(error.message || 'Failed to add product', 'danger');
    });
}

function editProduct(productId) {
    fetch(`/api/products/products/${productId}`)
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(product => {
            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-category').value = product.category_id;
            document.getElementById('edit-product-description').value = product.description || '';
            document.getElementById('edit-product-unit-price').value = product.unit_price;
            document.getElementById('edit-product-cost-price').value = product.cost_price || '';
            document.getElementById('edit-product-stock-quantity').value = product.stock_quantity;
            document.getElementById('edit-product-minimum-stock').value = product.minimum_stock_level || '';
            document.getElementById('edit-product-uom').value = product.unit_of_measure;
            document.getElementById('edit-product-is-fuel').value = product.is_fuel ? 'true' : 'false';
            document.getElementById('edit-product-status').value = product.is_active ? 'true' : 'false';
            document.getElementById('edit-product-barcode').value = product.barcode || '';
            document.getElementById('edit-product-image-url').value = product.image_url || '';
            
            const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error fetching product:', error);
            showToast(error.message || 'Failed to fetch product details', 'danger');
        });
}

function updateProduct() {
    const productId = document.getElementById('edit-product-id').value;
    const updates = {
        name: document.getElementById('edit-product-name').value,
        category_id: document.getElementById('edit-product-category').value,
        description: document.getElementById('edit-product-description').value,
        unit_price: parseFloat(document.getElementById('edit-product-unit-price').value),
        cost_price: document.getElementById('edit-product-cost-price').value ? 
            parseFloat(document.getElementById('edit-product-cost-price').value) : null,
        stock_quantity: parseFloat(document.getElementById('edit-product-stock-quantity').value),
        minimum_stock_level: document.getElementById('edit-product-minimum-stock').value ? 
            parseFloat(document.getElementById('edit-product-minimum-stock').value) : null,
        unit_of_measure: document.getElementById('edit-product-uom').value,
        is_fuel: document.getElementById('edit-product-is-fuel').value === 'true',
        is_active: document.getElementById('edit-product-status').value === 'true',
        barcode: document.getElementById('edit-product-barcode').value || null,
        image_url: document.getElementById('edit-product-image-url').value || null
    };
    
    fetch(`/api/products/products/${productId}`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updates)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        showToast('Product updated successfully', 'success');
        const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
        modal.hide();
        loadProducts();
    })
    .catch(error => {
        console.error('Error updating product:', error);
        showToast(error.message || 'Failed to update product', 'danger');
    });
}

function deleteProduct() {
    if (!confirm('Are you sure you want to delete this product? This action cannot be undone!')) {
        return;
    }
    
    const productId = document.getElementById('edit-product-id').value;
    
    fetch(`/api/products/products/${productId}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        showToast('Product deleted successfully', 'success');
        const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
        modal.hide();
        loadProducts();
    })
    .catch(error => {
        console.error('Error deleting product:', error);
        showToast(error.message || 'Failed to delete product', 'danger');
    });
}

function adjustStockModal(productId) {
    fetch(`/api/products/products/${productId}`)
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(product => {
            document.getElementById('adjust-product-id').value = product.id;
            document.getElementById('adjust-product-name').textContent = product.name;
            document.getElementById('adjust-current-stock').textContent = 
                `${product.stock_quantity} ${product.unit_of_measure}`;
            
            // Reset form fields
            document.getElementById('adjust-quantity').value = '';
            document.getElementById('adjust-reason').value = '';
            document.getElementById('adjust-reference').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('adjustStockModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error fetching product:', error);
            showToast(error.message || 'Failed to fetch product details', 'danger');
        });
}

function adjustStock() {
    const productId = document.getElementById('adjust-product-id').value;
    const quantity = parseFloat(document.getElementById('adjust-quantity').value);
    const reason = document.getElementById('adjust-reason').value;
    const reference = document.getElementById('adjust-reference').value;
    
    if (!reason) {
        showToast('Please select a transaction type', 'warning');
        return;
    }
    
    fetch(`/api/products/products/${productId}/stock`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            quantity_change: quantity,
            transaction_type: reason,
            reference: reference || null
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        showToast('Stock updated successfully', 'success');
        const modal = bootstrap.Modal.getInstance(document.getElementById('adjustStockModal'));
        modal.hide();
        loadProducts();
    })
    .catch(error => {
        console.error('Error adjusting stock:', error);
        showToast(error.message || 'Failed to adjust stock', 'danger');
    });
}

function showToast(message, type) {
    // Create toast HTML
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true" id="${toastId}">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    // Add toast to container (create it if it doesn't exist)
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    toastContainer.innerHTML += toastHtml;
    
    // Initialize and show the toast
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();
    
    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}
</script>
{% endblock %}
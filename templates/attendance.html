{% extends "layout.html" %}

{% block title %}Staff Attendance{% endblock %}

{% block page_title %}Staff Attendance Tracking{% endblock %}

<script>
window.currentUser = {
  is_admin: {{ current_user.is_admin()|tojson }},
  branch_id: {{ current_user.branch_id|tojson }},
  role: {{ current_user.role|tojson }}
};
</script>

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <ul class="nav nav-tabs" id="attendanceTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="today-tab" data-bs-toggle="tab" data-bs-target="#today" type="button" role="tab" aria-controls="today" aria-selected="true">Today's Attendance</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">Attendance History</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button" role="tab" aria-controls="schedule" aria-selected="false">Staff Schedule</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab" aria-controls="reports" aria-selected="false">Attendance Reports</button>
            </li>
        </ul>
    </div>
</div>

<div class="tab-content" id="attendanceTabContent">
    <!-- Today's Attendance Tab -->
    <div class="tab-pane fade show active" id="today" role="tabpanel" aria-labelledby="today-tab">
        <div class="row">
            <div class="col-md-8 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Today's Attendance</span>
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#recordAttendanceModal">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M12 2a10 10 0 1 0 10 10H12V2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            Record Attendance
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Shift</th>
                                        <th>Check-in Time</th>
                                        <th>Status</th>
                                        <th>Hours</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="today-attendance-table">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-attendance-today" class="text-center py-4 d-none">
                            <p class="text-muted">No attendance records for today</p>
                        </div>
                        <div id="loading-attendance" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading attendance records...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <span>Shift Coverage</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Morning Shift (6 AM - 2 PM)</span>
                                <span id="morning-count">0/3</span>
                            </div>
                            <div class="progress mb-1">
                                <div class="progress-bar bg-success" id="morning-progress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small class="text-muted">Staff: <span id="morning-staff">-</span></small>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Afternoon Shift (2 PM - 10 PM)</span>
                                <span id="afternoon-count">0/3</span>
                            </div>
                            <div class="progress mb-1">
                                <div class="progress-bar bg-info" id="afternoon-progress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small class="text-muted">Staff: <span id="afternoon-staff">-</span></small>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Night Shift (10 PM - 6 AM)</span>
                                <span id="night-count">0/2</span>
                            </div>
                            <div class="progress mb-1">
                                <div class="progress-bar bg-primary" id="night-progress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small class="text-muted">Staff: <span id="night-staff">-</span></small>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <span>Today's Statistics</span>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <h6 class="text-muted">Present</h6>
                                <h3 id="present-count">0</h3>
                            </div>
                            <div class="col-6 mb-3">
                                <h6 class="text-muted">Absent</h6>
                                <h3 id="absent-count">0</h3>
                            </div>
                            <div class="col-6 mb-3">
                                <h6 class="text-muted">Late</h6>
                                <h3 id="late-count">0</h3>
                            </div>
                            <div class="col-6 mb-3">
                                <h6 class="text-muted">On Leave</h6>
                                <h3 id="leave-count">0</h3>
                            </div>
                        </div>
                        <div class="text-center mt-2">
                            <h6 class="text-muted">Attendance Rate</h6>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" id="attendance-rate" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Attendance History Tab -->
    <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Attendance History</span>
                        <div class="d-flex">
                            <div class="input-group input-group-sm me-2" style="width: 150px">
                                <span class="input-group-text">From</span>
                                <input type="date" class="form-control" id="history-start-date">
                            </div>
                            <div class="input-group input-group-sm me-2" style="width: 150px">
                                <span class="input-group-text">To</span>
                                <input type="date" class="form-control" id="history-end-date">
                            </div>
                            <div class="input-group input-group-sm me-2" style="width: 200px">
                                <span class="input-group-text">Employee</span>
                                <select class="form-select" id="history-employee">
                                    <option value="">All Employees</option>
                                    <!-- Employees will be loaded here -->
                                </select>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" id="filter-history-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                                Filter
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Employee</th>
                                        <th>Shift</th>
                                        <th>Check-in</th>
                                        <th>Check-out</th>
                                        <th>Hours Worked</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-history" class="text-center py-4 d-none">
                            <p class="text-muted">No attendance records found for the selected criteria</p>
                        </div>
                        <div id="loading-history" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading attendance history...</p>
                        </div>
                        
                        <nav aria-label="Attendance history pagination" class="mt-3">
                            <ul class="pagination justify-content-center" id="history-pagination">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="Previous" id="history-prev">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="Next" id="history-next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <span>Attendance Trends</span>
                    </div>
                    <div class="card-body">
                        <canvas id="attendance-trends-chart" height="250"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <span>Top Performers</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Attendance Rate</th>
                                        <th>Punctuality</th>
                                        <th>Hours</th>
                                    </tr>
                                </thead>
                                <tbody id="performers-table">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Staff Schedule Tab -->
    <div class="tab-pane fade" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Weekly Schedule</span>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-2" id="prev-week-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                                Previous Week
                            </button>
                            <button class="btn btn-sm btn-outline-primary me-2" id="current-week-btn">
                                Current Week
                            </button>
                            <button class="btn btn-sm btn-outline-secondary me-2" id="next-week-btn">
                                Next Week
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                            </button>
                            <button class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M12 5v14M5 12h14"></path></svg>
                                Add Schedule
                            </button>
                            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#generateScheduleModal">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                Auto-Generate Schedule
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <h5 class="text-center mb-4" id="schedule-date-range">April 7 - April 13, 2025</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th style="width: 200px">Employee</th>
                                        <th>Monday</th>
                                        <th>Tuesday</th>
                                        <th>Wednesday</th>
                                        <th>Thursday</th>
                                        <th>Friday</th>
                                        <th>Saturday</th>
                                        <th>Sunday</th>
                                    </tr>
                                </thead>
                                <tbody id="schedule-table">
                                    <!-- Schedule data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="loading-schedule" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading schedule...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Shift Assignment</span>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#assignShiftModal">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Assign Shift
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <div class="input-group" style="width: 200px">
                                <span class="input-group-text">Employee</span>
                                <select class="form-select" id="shift-employee">
                                    <option value="">Select Employee</option>
                                    <!-- Employees will be loaded here -->
                                </select>
                            </div>
                            <div class="input-group" style="width: 200px">
                                <span class="input-group-text">Date</span>
                                <input type="date" class="form-control" id="shift-date">
                            </div>
                            <button class="btn btn-outline-secondary" id="view-shifts-btn">
                                View Shifts
                            </button>
                        </div>
                        
                        <div id="employee-shifts" class="mt-4">
                            <h6 class="mb-3">Assigned Shifts</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Shift</th>
                                            <th>Time</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="employee-shifts-table">
                                        <!-- Shifts will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="no-shifts" class="text-center py-3 d-none">
                                <p class="text-muted">No shifts assigned for the selected criteria</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <span>Shift Distribution</span>
                    </div>
                    <div class="card-body">
                        <canvas id="shift-distribution-chart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Attendance Reports Tab -->
    <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <span>Generate Attendance Report</span>
                    </div>
                    <div class="card-body">
                        <form id="report-form" class="row g-3">
                            <div class="col-md-3">
                                <label for="report-type" class="form-label">Report Type</label>
                                <select class="form-select" id="report-type" required>
                                    <option value="">Select Report Type</option>
                                    <option value="daily">Daily Attendance</option>
                                    <option value="summary">Monthly Summary</option>
                                    <option value="employee">Employee Attendance</option>
                                    <option value="shift">Shift Coverage</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="report-start-date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="report-start-date" required>
                            </div>
                            <div class="col-md-3">
                                <label for="report-end-date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="report-end-date" required>
                            </div>
                            <div class="col-md-3">
                                <label for="report-employee" class="form-label">Employee (Optional)</label>
                                <select class="form-select" id="report-employee">
                                    <option value="">All Employees</option>
                                    <!-- Employees will be loaded here -->
                                </select>
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="report-include-charts" checked>
                                    <label class="form-check-label" for="report-include-charts">
                                        Include Charts and Visualizations
                                    </label>
                                </div>
                            </div>
                            <div class="col-12 text-end">
                                <button type="button" class="btn btn-outline-secondary me-2" id="preview-report-btn">Preview Report</button>
                                <button type="submit" class="btn btn-primary">Generate Report</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <span>Recent Reports</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Report Type</th>
                                        <th>Period</th>
                                        <th>Generated On</th>
                                        <th>Generated By</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="reports-table">
                                    <!-- Reports will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-reports" class="text-center py-4 d-none">
                            <p class="text-muted">No reports have been generated yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Record Attendance Modal -->
<div class="modal fade" id="recordAttendanceModal" tabindex="-1" aria-labelledby="recordAttendanceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="recordAttendanceModalLabel">Record Attendance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="attendance-form">
                    <div class="mb-3">
                        <label for="attendance-employee" class="form-label">Employee</label>
                        <select class="form-select" id="attendance-employee" name="employee_id" required>
                            <option value="">Select Employee</option>
                            <!-- Employees will be loaded here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="attendance-type" class="form-label">Attendance Type</label>
                        <select class="form-select" id="attendance-type" name="attendance_type" required>
                            <option value="check-in">Check-in</option>
                            <option value="check-out">Check-out</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="attendance-time" class="form-label">Time</label>
                        <input type="datetime-local" class="form-control" id="attendance-time" name="timestamp" required>
                    </div>
                    <div class="mb-3">
                        <label for="attendance-shift" class="form-label">Shift</label>
                        <select class="form-select" id="attendance-shift" name="shift" required>
                            <option value="morning">Morning (6 AM - 2 PM)</option>
                            <option value="afternoon">Afternoon (2 PM - 10 PM)</option>
                            <option value="night">Night (10 PM - 6 AM)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="attendance-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="attendance-notes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-attendance-btn">Save Record</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Shift Modal -->
<div class="modal fade" id="assignShiftModal" tabindex="-1" aria-labelledby="assignShiftModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignShiftModalLabel">Assign Shift</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="assign-shift-form">
                    <div class="mb-3">
                        <label for="assign-employee" class="form-label">Employee</label>
                        <select class="form-select" id="assign-employee" name="employee_id" required>
                            <option value="">Select Employee</option>
                            <!-- Employees will be loaded here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="assign-shift" class="form-label">Shift</label>
                        <select class="form-select" id="assign-shift" name="shift" required>
                            <option value="morning">Morning (6 AM - 2 PM)</option>
                            <option value="afternoon">Afternoon (2 PM - 10 PM)</option>
                            <option value="night">Night (10 PM - 6 AM)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="assign-date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="assign-date" name="date" required>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="repeat-shift">
                        <label class="form-check-label" for="repeat-shift">
                            Repeat this shift
                        </label>
                    </div>
                    <div id="repeat-options" class="mb-3 d-none">
                        <label class="form-label">Repeat Options</label>
                        <div class="d-flex gap-2 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="repeatType" id="repeat-daily" value="daily">
                                <label class="form-check-label" for="repeat-daily">
                                    Daily
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="repeatType" id="repeat-weekly" value="weekly" checked>
                                <label class="form-check-label" for="repeat-weekly">
                                    Weekly
                                </label>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label for="repeat-until" class="form-label">Repeat Until</label>
                            <input type="date" class="form-control" id="repeat-until">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-shift-btn">Assign Shift</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize datepickers
    const now = new Date();
    
    // Set today's date for default values
    const todayStr = formatDateForInput(now);
    const shiftDateEl = document.getElementById('shift-date');
    if (shiftDateEl) shiftDateEl.value = todayStr;
    const assignDateEl = document.getElementById('assign-date');
    if (assignDateEl) assignDateEl.value = todayStr;
    // Set attendance time to now
    const currentTimeStr = now.toISOString().slice(0, 16);
    const attendanceTimeEl = document.getElementById('attendance-time');
    if (attendanceTimeEl) attendanceTimeEl.value = currentTimeStr;
    // Set date ranges for history tab
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    
    const historyStartDateEl = document.getElementById('history-start-date');
    if (historyStartDateEl) historyStartDateEl.value = formatDateForInput(startOfMonth);
    const historyEndDateEl = document.getElementById('history-end-date');
    if (historyEndDateEl) historyEndDateEl.value = formatDateForInput(endOfMonth);
    const reportStartDateEl = document.getElementById('report-start-date');
    if (reportStartDateEl) reportStartDateEl.value = formatDateForInput(startOfMonth);
    const reportEndDateEl = document.getElementById('report-end-date');
    if (reportEndDateEl) reportEndDateEl.value = formatDateForInput(endOfMonth);
    
    // Load data when tab is shown
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            const targetId = event.target.getAttribute('data-bs-target').substring(1);
            
            switch(targetId) {
                case 'today':
                    loadTodayAttendance();
                    break;
                case 'history':
                    loadAttendanceHistory();
                    break;
                case 'schedule':
                    loadWeeklySchedule();
                    break;
                case 'reports':
                    loadRecentReports();
                    break;
            }
        });
    });
    
    // Toggle repeat options when checkbox changes
    const repeatShiftEl = document.getElementById('repeat-shift');
    if (repeatShiftEl) {
        repeatShiftEl.addEventListener('change', function() {
            const repeatOptions = document.getElementById('repeat-options');
            if (this.checked) {
                repeatOptions.classList.remove('d-none');
            } else {
                repeatOptions.classList.add('d-none');
            }
        });
    }
    
    // Filter history button
    const filterHistoryBtn = document.getElementById('filter-history-btn');
    if (filterHistoryBtn) {
        filterHistoryBtn.addEventListener('click', function() {
            loadAttendanceHistory();
        });
    }
    
    // View shifts button
    const viewShiftsBtn = document.getElementById('view-shifts-btn');
    if (viewShiftsBtn) {
        viewShiftsBtn.addEventListener('click', function() {
            const employeeId = document.getElementById('shift-employee').value;
            const date = document.getElementById('shift-date').value;
            
            if (!employeeId && !date) {
                showAlert('Please select at least an employee or a date', 'warning');
                return;
            }
            
            loadEmployeeShifts(employeeId, date);
        });
    }
    
    // Schedule navigation buttons
    const prevWeekBtn = document.getElementById('prev-week-btn');
    if (prevWeekBtn) {
        prevWeekBtn.addEventListener('click', function() {
            document.getElementById('schedule-date-range').textContent = 'March 31 - April 6, 2025';
        });
    }
    
    const currentWeekBtn = document.getElementById('current-week-btn');
    if (currentWeekBtn) {
        currentWeekBtn.addEventListener('click', function() {
            document.getElementById('schedule-date-range').textContent = 'April 7 - April 13, 2025';
        });
    }
    
    const nextWeekBtn = document.getElementById('next-week-btn');
    if (nextWeekBtn) {
        nextWeekBtn.addEventListener('click', function() {
            document.getElementById('schedule-date-range').textContent = 'April 14 - April 20, 2025';
        });
    }
    
    // Save attendance button
    const saveAttendanceBtn = document.getElementById('save-attendance-btn');
    if (saveAttendanceBtn) {
        saveAttendanceBtn.addEventListener('click', function() {
            const form = document.getElementById('attendance-form');
            
            if (form.checkValidity()) {
                const employeeId = document.getElementById('attendance-employee').value;
                const type = document.getElementById('attendance-type').value;
                const timestamp = document.getElementById('attendance-time').value;
                const shift = document.getElementById('attendance-shift').value;
                const notes = document.getElementById('attendance-notes').value;
                
                // Prepare data based on check-in or check-out
                let endpoint = '';
                let data = {};
                
                if (type === 'check-in') {
                    endpoint = '/api/staff/attendance/check-in';
                    data = {
                        employee_id: employeeId,
                        check_in: new Date(timestamp).toISOString(),
                        shift: shift,
                        notes: notes
                    };
                } else {
                    // For check-out, we'd need to determine the attendance record ID
                    // For now, we'll simulate it with a placeholder
                    const attendanceId = 1; // This would normally come from finding the active attendance record
                    endpoint = `/api/staff/attendance/check-out/${attendanceId}`;
                    data = {};
                }
                
                // In a real app, you would send this to your API
                console.log('Attendance data:', endpoint, data);
                
                // Simulate success
                const modal = bootstrap.Modal.getInstance(document.getElementById('recordAttendanceModal'));
                modal.hide();
                showAlert('Attendance recorded successfully', 'success');
                
                // Reload today's attendance
                loadTodayAttendance();
            } else {
                form.reportValidity();
            }
        });
    }
    
    // Save shift assignment button
    const saveShiftBtn = document.getElementById('save-shift-btn');
    if (saveShiftBtn) {
        saveShiftBtn.addEventListener('click', function() {
            const form = document.getElementById('assign-shift-form');
            
            if (form.checkValidity()) {
                const employeeId = document.getElementById('assign-employee').value;
                const shift = document.getElementById('assign-shift').value;
                const date = document.getElementById('assign-date').value;
                
                // Check if repeat is enabled
                const repeatEnabled = document.getElementById('repeat-shift').checked;
                let repeatData = null;
                
                if (repeatEnabled) {
                    const repeatType = document.querySelector('input[name="repeatType"]:checked').value;
                    const repeatUntil = document.getElementById('repeat-until').value;
                    
                    repeatData = {
                        type: repeatType,
                        until: repeatUntil
                    };
                }
                
                const data = {
                    employee_id: employeeId,
                    shift: shift,
                    date: date,
                    repeat: repeatData
                };
                
                // In a real app, you would send this to your API
                console.log('Shift assignment data:', data);
                
                // Simulate success
                const modal = bootstrap.Modal.getInstance(document.getElementById('assignShiftModal'));
                modal.hide();
                showAlert('Shift assigned successfully', 'success');
                
                // Reload weekly schedule
                loadWeeklySchedule();
            } else {
                form.reportValidity();
            }
        });
    }
    
    // Report form submit handler
    const reportForm = document.getElementById('report-form');
    if (reportForm) {
        reportForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const reportTypeEl = document.getElementById('report-type');
            const startDateEl = document.getElementById('report-start-date');
            const endDateEl = document.getElementById('report-end-date');
            const employeeIdEl = document.getElementById('report-employee');
            const includeChartsEl = document.getElementById('report-include-charts');
            if (!reportTypeEl || !startDateEl || !endDateEl || !employeeIdEl || !includeChartsEl) {
                showAlert('Some report fields are missing in the DOM.', 'danger');
                return;
            }
            const reportType = reportTypeEl.value;
            const startDate = startDateEl.value;
            const endDate = endDateEl.value;
            const employeeId = employeeIdEl.value;
            const includeCharts = includeChartsEl.checked;
            
            const data = {
                report_type: reportType,
                start_date: startDate,
                end_date: endDate,
                employee_id: employeeId,
                include_charts: includeCharts
            };
            
            // In a real app, you would send this to your API
            console.log('Report generation data:', data);
            
            showAlert('Report generation started. You will be notified when it\'s complete.', 'info');
        });
    }
    
    // Load initial data for the default tab (today)
    loadTodayAttendance();
    loadAttendanceCharts();
    
    // Load employees for all select dropdowns
    loadEmployees();
});

// Load today's attendance data
function loadTodayAttendance() {
    // Show loading indicator
    document.getElementById('loading-attendance').style.display = 'block';
    document.getElementById('no-attendance-today').classList.add('d-none');
    
    // In a real app, fetch data from your API
    fetch('/api/staff/attendance/today')
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading-attendance').style.display = 'none';
            
            if (data.length === 0) {
                document.getElementById('no-attendance-today').classList.remove('d-none');
                return;
            }
            
            // Process attendance data
            const tableBody = document.getElementById('today-attendance-table');
            tableBody.innerHTML = '';
            
            // Counters for shift coverage
            const shifts = {
                morning: { count: 0, staff: [] },
                afternoon: { count: 0, staff: [] },
                night: { count: 0, staff: [] }
            };
            
            // Counters for attendance statistics
            let present = 0;
            let absent = 0;  // This would normally come from scheduled vs. actual
            let late = 0;
            let onLeave = 0;
            
            // Get employee names (in real app, this would be part of the attendance data)
            fetch('/api/staff/attendants')
                .then(response => response.json())
                .then(employees => {
                    // Create employee lookup
                    const employeeMap = {};
                    employees.forEach(emp => {
                        employeeMap[emp.employee_id] = emp.name;
                    });
                    
                    data.forEach(record => {
                        // Increment shift counter
                        if (shifts[record.shift]) {
                            shifts[record.shift].count++;
                            shifts[record.shift].staff.push(employeeMap[record.employee_id] || record.employee_id);
                        }
                        
                        present++;
                        
                        // Create row for attendance record
                        const row = document.createElement('tr');
                        
                        // Calculate hours if check-out exists
                        let hours = '-';
                        let status = 'Checked In';
                        let statusClass = 'success';
                        
                        if (record.check_out) {
                            const checkIn = new Date(record.check_in);
                            const checkOut = new Date(record.check_out);
                            const diffMs = checkOut - checkIn;
                            const diffHrs = (diffMs / (1000 * 60 * 60)).toFixed(1);
                            hours = diffHrs + ' hrs';
                            status = 'Completed';
                        }
                        
                        // Check for late arrival (simplified example)
                        const checkIn = new Date(record.check_in);
                        let expectedHour;
                        
                        switch(record.shift) {
                            case 'morning':
                                expectedHour = 6;
                                break;
                            case 'afternoon':
                                expectedHour = 14;
                                break;
                            case 'night':
                                expectedHour = 22;
                                break;
                        }
                        
                        if (checkIn.getHours() > expectedHour) {
                            status = 'Late';
                            statusClass = 'warning';
                            late++;
                        }
                        
                        row.innerHTML = `
                            <td>${employeeMap[record.employee_id] || record.employee_id}</td>
                            <td class="text-capitalize">${record.shift}</td>
                            <td>${new Date(record.check_in).toLocaleTimeString()}</td>
                            <td><span class="badge bg-${statusClass}">${status}</span></td>
                            <td>${hours}</td>
                            <td>
                                ${!record.check_out ? `
                                <button class="btn btn-sm btn-outline-primary record-checkout-btn" data-id="${record.id}">
                                    Check Out
                                </button>
                                ` : '-'}
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                    
                    // Add event listeners for check-out buttons
                    document.querySelectorAll('.record-checkout-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const attendanceId = this.getAttribute('data-id');
                            recordCheckOut(attendanceId);
                        });
                    });
                    
                    // Update shift coverage indicators
                    updateShiftCoverage(shifts);
                    
                    // Update attendance statistics
                    // In a real app, these would be calculated from scheduled vs. actual data
                    absent = 2;  // Example value
                    onLeave = 1;  // Example value
                    
                    document.getElementById('present-count').textContent = present;
                    document.getElementById('absent-count').textContent = absent;
                    document.getElementById('late-count').textContent = late;
                    document.getElementById('leave-count').textContent = onLeave;
                    
                    // Calculate attendance rate
                    const total = present + absent + onLeave;
                    const rate = Math.round((present / total) * 100);
                    
                    const rateEl = document.getElementById('attendance-rate');
                    rateEl.style.width = rate + '%';
                    rateEl.textContent = rate + '%';
                    
                    // Set appropriate color based on rate
                    if (rate < 70) {
                        rateEl.classList.remove('bg-success', 'bg-warning');
                        rateEl.classList.add('bg-danger');
                    } else if (rate < 90) {
                        rateEl.classList.remove('bg-success', 'bg-danger');
                        rateEl.classList.add('bg-warning');
                    } else {
                        rateEl.classList.remove('bg-warning', 'bg-danger');
                        rateEl.classList.add('bg-success');
                    }
                })
                .catch(error => {
                    console.error('Error loading employee data:', error);
                    showAlert('Error loading employee data: ' + error.message, 'danger');
                });
        })
        .catch(error => {
            document.getElementById('loading-attendance').style.display = 'none';
            document.getElementById('no-attendance-today').classList.remove('d-none');
            document.getElementById('no-attendance-today').innerHTML = `<p class="text-danger">Error loading attendance: ${error.message}</p>`;
            console.error('Error loading attendance data:', error);
        });
}

// Record check-out for an attendance record
function recordCheckOut(attendanceId) {
    // In a real app, send this to your API
    fetch(`/api/staff/attendance/check-out/${attendanceId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showAlert('Check-out recorded successfully', 'success');
            loadTodayAttendance();
        } else {
            showAlert('Error: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error recording check-out: ' + error.message, 'danger');
        console.error('Error recording check-out:', error);
    });
}

// Update shift coverage indicators
function updateShiftCoverage(shifts) {
    // Morning shift
    const morningMax = 3;
    const morningCount = shifts.morning.count;
    const morningPercentage = Math.min(100, (morningCount / morningMax) * 100);
    
    document.getElementById('morning-count').textContent = morningCount + '/' + morningMax;
    document.getElementById('morning-progress').style.width = morningPercentage + '%';
    document.getElementById('morning-staff').textContent = shifts.morning.staff.join(', ') || 'None';
    
    // Afternoon shift
    const afternoonMax = 3;
    const afternoonCount = shifts.afternoon.count;
    const afternoonPercentage = Math.min(100, (afternoonCount / afternoonMax) * 100);
    
    document.getElementById('afternoon-count').textContent = afternoonCount + '/' + afternoonMax;
    document.getElementById('afternoon-progress').style.width = afternoonPercentage + '%';
    document.getElementById('afternoon-staff').textContent = shifts.afternoon.staff.join(', ') || 'None';
    
    // Night shift
    const nightMax = 2;
    const nightCount = shifts.night.count;
    const nightPercentage = Math.min(100, (nightCount / nightMax) * 100);
    
    document.getElementById('night-count').textContent = nightCount + '/' + nightMax;
    document.getElementById('night-progress').style.width = nightPercentage + '%';
    document.getElementById('night-staff').textContent = shifts.night.staff.join(', ') || 'None';
}

// Load attendance history
function loadAttendanceHistory(page = 1, limit = 10) {
    // Show loading indicator
    document.getElementById('loading-history').style.display = 'block';
    document.getElementById('no-history').classList.add('d-none');
    
    // Get filter values
    const startDate = document.getElementById('history-start-date').value;
    const endDate = document.getElementById('history-end-date').value;
    const employeeId = document.getElementById('history-employee').value;
    
    // Build query parameters
    let params = new URLSearchParams();
    
    if (startDate) {
        params.append('start_date', new Date(startDate).toISOString());
    }
    
    if (endDate) {
        // End of the selected day
        const endOfDay = new Date(endDate);
        endOfDay.setHours(23, 59, 59);
        params.append('end_date', endOfDay.toISOString());
    }
    
    if (employeeId) {
        params.append('employee_id', employeeId);
    }
    
    params.append('limit', limit);
    params.append('offset', (page - 1) * limit);
    
    // In a real app, fetch data from your API
    fetch(`/api/staff/attendance?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading-history').style.display = 'none';
            
            if (data.length === 0) {
                document.getElementById('no-history').classList.remove('d-none');
                return;
            }
            
            // Process attendance data
            const tableBody = document.getElementById('history-table');
            tableBody.innerHTML = '';
            
            // Get employee names (in real app, this would be part of the attendance data)
            fetch('/api/staff/attendants')
                .then(response => response.json())
                .then(employees => {
                    // Create employee lookup
                    const employeeMap = {};
                    employees.forEach(emp => {
                        employeeMap[emp.employee_id] = emp.name;
                    });
                    
                    data.forEach(record => {
                        // Create row for attendance record
                        const row = document.createElement('tr');
                        
                        // Calculate hours if check-out exists
                        let hours = '-';
                        let status = 'Incomplete';
                        let statusClass = 'warning';
                        
                        if (record.check_out) {
                            const checkIn = new Date(record.check_in);
                            const checkOut = new Date(record.check_out);
                            const diffMs = checkOut - checkIn;
                            const diffHrs = (diffMs / (1000 * 60 * 60)).toFixed(1);
                            hours = diffHrs + ' hrs';
                            status = 'Complete';
                            statusClass = 'success';
                        }
                        
                        // Check for late arrival (simplified example)
                        const checkIn = new Date(record.check_in);
                        let expectedHour;
                        
                        switch(record.shift) {
                            case 'morning':
                                expectedHour = 6;
                                break;
                            case 'afternoon':
                                expectedHour = 14;
                                break;
                            case 'night':
                                expectedHour = 22;
                                break;
                        }
                        
                        if (checkIn.getHours() > expectedHour) {
                            status = 'Late';
                            statusClass = 'warning';
                        }
                        
                        const checkInDate = new Date(record.check_in);
                        const checkOutStr = record.check_out ? new Date(record.check_out).toLocaleTimeString() : '-';
                        
                        row.innerHTML = `
                            <td>${checkInDate.toLocaleDateString()}</td>
                            <td>${employeeMap[record.employee_id] || record.employee_id}</td>
                            <td class="text-capitalize">${record.shift}</td>
                            <td>${checkInDate.toLocaleTimeString()}</td>
                            <td>${checkOutStr}</td>
                            <td>${hours}</td>
                            <td><span class="badge bg-${statusClass}">${status}</span></td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading employee data:', error);
                });
                
            // Update pagination
            document.getElementById('history-prev').parentElement.classList.toggle('disabled', page === 1);
            document.querySelector('#history-pagination .page-item.active .page-link').textContent = page;
            document.getElementById('history-next').parentElement.classList.toggle('disabled', data.length < limit);
            
            // Add event listeners for pagination
            const historyPrev = document.getElementById('history-prev');
            if (historyPrev) {
                historyPrev.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (page > 1) {
                        loadAttendanceHistory(page - 1, limit);
                    }
                });
            }
            
            const historyNext = document.getElementById('history-next');
            if (historyNext) {
                historyNext.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (data.length === limit) {
                        loadAttendanceHistory(page + 1, limit);
                    }
                });
            }
        })
        .catch(error => {
            document.getElementById('loading-history').style.display = 'none';
            document.getElementById('no-history').classList.remove('d-none');
            document.getElementById('no-history').innerHTML = `<p class="text-danger">Error loading attendance history: ${error.message}</p>`;
            console.error('Error loading attendance history:', error);
        });
}

// Load weekly schedule
function loadWeeklySchedule() {
    // Show loading indicator
    document.getElementById('loading-schedule').style.display = 'block';
    
    // In a real app, you would fetch this data from your API
    // For this demonstration, we'll use mock data
    
    // Get employee names from API
    fetch('/api/staff/attendants')
        .then(response => response.json())
        .then(employees => {
            document.getElementById('loading-schedule').style.display = 'none';
            
            // Create weekly schedule table
            const tableBody = document.getElementById('schedule-table');
            tableBody.innerHTML = '';
            
            // Filter to active employees
            const activeEmployees = employees.filter(emp => emp.active);
            
            // Get date range for the week
            const startDate = getCurrentWeekStartDate();
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 6);
            
            // Format dates for API
            const formattedStartDate = formatDate(startDate);
            const formattedEndDate = formatDate(endDate);
            
            // Fetch schedule data for the week
            fetch(`/api/staff/schedule?start_date=${formattedStartDate}&end_date=${formattedEndDate}`)
                .then(response => response.json())
                .then(schedules => {
                    // Create a row for each employee
                    activeEmployees.forEach(employee => {
                        const row = document.createElement('tr');
                        
                        // Employee name cell
                        const nameCell = document.createElement('td');
                        nameCell.classList.add('fw-bold');
                        nameCell.textContent = employee.name;
                        row.appendChild(nameCell);
                        
                        // Create cells for each day of the week
                        for (let i = 0; i < 7; i++) {
                            const currentDate = new Date(startDate);
                            currentDate.setDate(startDate.getDate() + i);
                            const formattedCellDate = formatDate(currentDate);
                            
                            // Find schedule for this employee on this day
                            const dailySchedules = schedules.filter(s => 
                                s.employee_id === employee.employee_id && 
                                s.schedule_date === formattedCellDate
                            );
                            
                            const cell = document.createElement('td');
                            
                            if (dailySchedules.length === 0) {
                                cell.innerHTML = '<span class="text-muted">OFF</span>';
                            } else {
                                // Could potentially have multiple shifts in a day
                                dailySchedules.forEach(schedule => {
                                    let shiftClass = '';
                                    let timeRange = '';
                                    
                                    switch(schedule.shift) {
                                        case 'morning':
                                            shiftClass = 'success';
                                            timeRange = '6 AM - 2 PM';
                                            break;
                                        case 'afternoon':
                                            shiftClass = 'info';
                                            timeRange = '2 PM - 10 PM';
                                            break;
                                        case 'night':
                                            shiftClass = 'primary';
                                            timeRange = '10 PM - 6 AM';
                                            break;
                                    }
                                    
                                    // Create content with notes tooltip if present
                                    const hasNotes = schedule.notes && schedule.notes.trim() !== '';
                                    const noteIndicator = hasNotes ? 
                                        `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ms-1"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>` : '';
                                    
                                    const scheduleEntry = document.createElement('div');
                                    scheduleEntry.classList.add('schedule-entry', 'mb-1');
                                    
                                    if (hasNotes) {
                                        scheduleEntry.setAttribute('data-bs-toggle', 'tooltip');
                                        scheduleEntry.setAttribute('data-bs-placement', 'top');
                                        scheduleEntry.setAttribute('title', schedule.notes);
                                    }
                                    
                                    scheduleEntry.innerHTML = `
                                        <div class="text-${shiftClass} text-capitalize d-flex align-items-center">
                                            ${schedule.shift}${noteIndicator}
                                        </div>
                                        <small class="text-muted">${timeRange}</small>
                                    `;
                                    
                                    // Add action buttons for edit/delete
                                    const actionButtons = document.createElement('div');
                                    actionButtons.classList.add('schedule-actions', 'mt-1');
                                    actionButtons.innerHTML = `
                                        <button class="btn btn-sm btn-outline-secondary me-1 edit-schedule-btn" 
                                            data-schedule-id="${schedule.id}" data-bs-toggle="modal" data-bs-target="#editScheduleModal">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-schedule-btn" data-schedule-id="${schedule.id}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                        </button>
                                    `;
                                    
                                    cell.appendChild(scheduleEntry);
                                    cell.appendChild(actionButtons);
                                });
                            }
                            
                            row.appendChild(cell);
                        }
                        
                        tableBody.appendChild(row);
                    });
                    
                    // Initialize tooltips after adding elements to DOM
                    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl);
                    });
                })
                .catch(error => {
                    console.error('Error loading schedules:', error);
                });
        })
        .catch(error => {
            document.getElementById('loading-schedule').style.display = 'none';
            console.error('Error loading employees:', error);
        });
}

// Load employee shifts
function loadEmployeeShifts(employeeId, date) {
    // In a real app, you would fetch this data from your API
    // For this demonstration, we'll use mock data
    
    const shiftsTable = document.getElementById('employee-shifts-table');
    shiftsTable.innerHTML = '';
    
    // Show "no shifts" message if no criteria
    if (!employeeId && !date) {
        document.getElementById('no-shifts').classList.remove('d-none');
        return;
    }
    
    // Hide "no shifts" message
    document.getElementById('no-shifts').classList.add('d-none');
    
    // Mock shifts data
    const shifts = [
        { date: '2025-04-07', shift: 'morning', time: '6 AM - 2 PM' },
        { date: '2025-04-08', shift: 'morning', time: '6 AM - 2 PM' },
        { date: '2025-04-09', shift: 'afternoon', time: '2 PM - 10 PM' },
        { date: '2025-04-10', shift: 'afternoon', time: '2 PM - 10 PM' },
        { date: '2025-04-11', shift: 'night', time: '10 PM - 6 AM' }
    ];
    
    // Filter shifts based on criteria
    let filteredShifts = shifts;
    
    if (date) {
        filteredShifts = filteredShifts.filter(s => s.date === date);
    }
    
    // In a real app, you would filter by employee ID here
    
    if (filteredShifts.length === 0) {
        document.getElementById('no-shifts').classList.remove('d-none');
        return;
    }
    
    // Add shifts to table
    filteredShifts.forEach(shift => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>${formatDate(new Date(shift.date))}</td>
            <td class="text-capitalize">${shift.shift}</td>
            <td>${shift.time}</td>
            <td>
                <button class="btn btn-sm btn-outline-danger delete-shift-btn" data-date="${shift.date}" data-shift="${shift.shift}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </td>
        `;
        
        shiftsTable.appendChild(row);
    });
    
    // Add event listeners for delete buttons
    document.querySelectorAll('.delete-shift-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const date = this.getAttribute('data-date');
            const shift = this.getAttribute('data-shift');
            
            if (confirm(`Are you sure you want to remove this ${shift} shift on ${formatDate(new Date(date))}?`)) {
                // In a real app, you would send a delete request to your API
                console.log('Deleting shift:', date, shift);
                
                // Remove the row from the table
                this.closest('tr').remove();
                
                // Show success message
                showAlert(`Shift removed successfully`, 'success');
                
                // Check if there are any shifts left
                if (shiftsTable.children.length === 0) {
                    document.getElementById('no-shifts').classList.remove('d-none');
                }
            }
        });
    });
}

// Load recent reports
function loadRecentReports() {
    // In a real app, you would fetch this data from your API
    // For this demonstration, we'll use mock data
    
    const reportsTable = document.getElementById('reports-table');
    reportsTable.innerHTML = '';
    
    // Mock reports data
    const reports = [
        { type: 'Daily Attendance', period: 'April 11, 2025', generated: 'April 11, 2025', by: 'John Peterson' },
        { type: 'Monthly Summary', period: 'March 2025', generated: 'April 1, 2025', by: 'System' },
        { type: 'Employee Attendance', period: 'March 1 - March 31, 2025', generated: 'April 1, 2025', by: 'John Peterson' },
        { type: 'Shift Coverage', period: 'March 2025', generated: 'April 1, 2025', by: 'System' },
        { type: 'Daily Attendance', period: 'April 10, 2025', generated: 'April 10, 2025', by: 'John Peterson' }
    ];
    
    if (reports.length === 0) {
        document.getElementById('no-reports').classList.remove('d-none');
        return;
    }
    
    document.getElementById('no-reports').classList.add('d-none');
    
    // Add reports to table
    reports.forEach(report => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>${report.type}</td>
            <td>${report.period}</td>
            <td>${report.generated}</td>
            <td>${report.by}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    View
                </button>
                <button class="btn btn-outline-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Download
                </button>
            </td>
        `;
        
        reportsTable.appendChild(row);
    });
}

// Load employees for dropdowns
function loadEmployees() {
    try {
        fetch('/api/staff/attendants')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(employees => {
                if (!Array.isArray(employees)) {
                    console.error('Employees data is not an array');
                    return;
                }
                
                // Get all employee dropdowns
                const dropdowns = [
                    document.getElementById('attendance-employee'),
                    document.getElementById('history-employee'),
                    document.getElementById('shift-employee'),
                    document.getElementById('assign-employee'),
                    document.getElementById('report-employee'),
                    document.getElementById('schedule-employee')
                ];
                
                // Filter to active employees and by branch for non-admins
                let filtered = employees.filter(emp => emp && emp.active);
                if (window.currentUser && !window.currentUser.is_admin) {
                    filtered = filtered.filter(emp => emp.branch_id === window.currentUser.branch_id);
                    // Optionally, filter by role (uncomment if required):
                    // filtered = filtered.filter(emp => emp.role === 'attendant');
                }
                
                // Update each dropdown
                dropdowns.forEach(dropdown => {
                    if (!dropdown) return;
                    
                    try {
                        // Clear existing options except the first one
                        while (dropdown.options.length > 1) {
                            dropdown.remove(1);
                        }
                        
                        // Add employee options
                        filtered.forEach(employee => {
                            if (!employee || !employee.employee_id || !employee.name) return;
                            
                            const option = document.createElement('option');
                            option.value = employee.employee_id;
                            option.textContent = `${employee.name} (${employee.employee_id})`;
                            dropdown.appendChild(option);
                        });
                    } catch (dropdownError) {
                        console.error('Error updating dropdown:', dropdownError);
                    }
                });
            })
            .catch(error => {
                console.error('Error loading employees:', error);
            });
    } catch (error) {
        console.error('Exception in loadEmployees:', error);
    }
}

// Create attendance charts
function loadAttendanceCharts() {
    // Create attendance trends chart
    const trendsCtx = document.getElementById('attendance-trends-chart');
    if (trendsCtx) {
        try {
            // Calculate date 30 days ago
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const formattedDate = formatDateStr(thirtyDaysAgo);
            
            fetch(`/api/staff/attendance?start_date=${formattedDate}`)
                .then(response => response.json())
                .then(data => {
                    // Group data by date
                    const attendanceByDate = {};
                    
                    // Generate date data for the last 30 days
                    for (let i = 30; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const dateStr = formatDateStr(date);
                        
                        attendanceByDate[dateStr] = {
                            date: dateStr,
                            count: Math.floor(Math.random() * 5) + 8, // Random number between 8-12
                            punctual: Math.floor(Math.random() * 3) + 7 // Random number between 7-9
                        };
                    }
                
                // Extract data for chart
                const labels = Object.keys(attendanceByDate).slice(0, 10); // Last 10 days
                const counts = labels.map(date => attendanceByDate[date].count);
                const punctual = labels.map(date => attendanceByDate[date].punctual);
                
                new Chart(trendsCtx, {
                    type: 'line',
                    data: {
                        labels: labels.map(date => formatDateShort(new Date(date))),
                        datasets: [
                            {
                                label: 'Total Attendance',
                                data: counts,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                fill: true,
                                tension: 0.1
                            },
                            {
                                label: 'Punctual',
                                data: punctual,
                                borderColor: 'rgba(153, 102, 255, 1)',
                                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                fill: true,
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
                
                // Populate top performers table
                const performersTable = document.getElementById('performers-table');
                if (performersTable) {
                    // In a real app, you would calculate these metrics from actual data
                    // For now, we'll use mock data
                    const performers = [
                        { name: 'John Peterson', rate: '98%', punctuality: '96%', hours: '168.5' },
                        { name: 'Sarah Williams', rate: '95%', punctuality: '92%', hours: '162.0' },
                        { name: 'David Martinez', rate: '94%', punctuality: '90%', hours: '160.5' },
                        { name: 'Emily Johnson', rate: '92%', punctuality: '95%', hours: '157.0' },
                        { name: 'Michael Chen', rate: '90%', punctuality: '88%', hours: '155.5' }
                    ];
                    
                    performersTable.innerHTML = '';
                    
                    performers.forEach(performer => {
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${performer.name}</td>
                            <td>${performer.rate}</td>
                            <td>${performer.punctuality}</td>
                            <td>${performer.hours} hrs</td>
                        `;
                        
                        performersTable.appendChild(row);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading attendance data for trends:', error);
            });
        } catch (error) {
            console.error('Error in loadAttendanceCharts:', error);
        }
    }
}

// Load shift distribution chart
function loadShiftDistributionChart() {
    const shiftDistCtx = document.getElementById('shift-distribution-chart');
    if (!shiftDistCtx) return;
    
    // In a real app, you would calculate this from actual data
    // For now, we'll use mock data
    const shiftCounts = {
        'morning': 18,
        'afternoon': 15,
        'night': 12,
        'off': 10
    };
    
    new Chart(shiftDistCtx, {
        type: 'doughnut',
        data: {
            labels: ['Morning', 'Afternoon', 'Night', 'Day Off'],
            datasets: [{
                data: Object.values(shiftCounts),
                backgroundColor: [
                    'rgba(40, 167, 69, 0.7)',  // Green for morning
                    'rgba(23, 162, 184, 0.7)', // Cyan for afternoon
                    'rgba(0, 123, 255, 0.7)',  // Blue for night
                    'rgba(108, 117, 125, 0.7)' // Gray for off
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(23, 162, 184, 1)',
                    'rgba(0, 123, 255, 1)',
                    'rgba(108, 117, 125, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                }
            }
        }
    });
}

// Helper function to format date for input fields
function formatDateForInput(date) {
    return date.toISOString().split('T')[0];
}

// Helper function to format date string (YYYY-MM-DD)
function formatDateStr(date) {
    return date.toISOString().split('T')[0];
}

// Helper function to format date (Month Day, Year)
function formatDate(date) {
    return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
}

// Helper function to format date (Mon DD)
function formatDateShort(date) {
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// Get the start date of the current week (Sunday)
function getCurrentWeekStartDate() {
    const now = new Date();
    const day = now.getDay(); // 0 for Sunday, 1 for Monday, etc.
    const diff = now.getDate() - day;
    return new Date(now.setDate(diff));
}

// Show alert message
function showAlert(message, type = 'info') {
    const alertsContainer = document.createElement('div');
    alertsContainer.className = 'position-fixed top-0 end-0 p-3';
    alertsContainer.style.zIndex = '1050';
    
    const alertHtml = `
        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">PetrolPro</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body bg-${type} text-white">
                ${message}
            </div>
        </div>
    `;
    
    alertsContainer.innerHTML = alertHtml;
    document.body.appendChild(alertsContainer);
    
    // Remove the alert after 5 seconds
    setTimeout(() => {
        alertsContainer.remove();
    }, 5000);
}

// Schedule management functions
function loadWeeklySchedule(startDate) {
    if (!startDate) {
        console.error('Invalid startDate parameter in loadWeeklySchedule');
        startDate = new Date(); // Fallback to current date
    }
    
    // Ensure startDate is a Date object
    if (typeof startDate === 'string') {
        startDate = new Date(startDate);
    }
    
    // Create a copy of the date to avoid modifying the original
    const endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 6); // End date is Sunday
    
    // Show loading spinner if it exists
    const loadingSpinner = document.getElementById('loading-schedule');
    if (loadingSpinner) {
        loadingSpinner.style.display = 'block';
    }
    
    // Format dates for API request
    const startStr = formatDateStr(startDate);
    const endStr = formatDateStr(endDate);
    
    // Update the date range display if it exists
    const dateRangeElement = document.getElementById('schedule-date-range');
    if (dateRangeElement) {
        const options = { month: 'long', day: 'numeric' };
        dateRangeElement.textContent = 
            `${startDate.toLocaleDateString('en-US', options)} - ${endDate.toLocaleDateString('en-US', options)}, ${endDate.getFullYear()}`;
    }
    
    // Fetch data from API
    fetch(`/api/staff/schedule?start_date=${startStr}&end_date=${endStr}`)
      .then(response => response.json())
      .then(data => {
          // Get fresh employee data to populate the schedule
          loadEmployees();
      })
      .catch(error => {
          console.error('Error loading schedule data:', error);
          showAlert('Error loading schedule data: ' + error.message, 'danger');
      })
      .finally(() => {
          // Hide loading indicator if it exists
          if (loadingSpinner) {
              loadingSpinner.style.display = 'none';
          }
      });
}

function createScheduleEntry(scheduleData) {
    // Submit the schedule data to the API
    fetch('/api/staff/schedule', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(scheduleData),
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to create schedule entry');
        }
        return response.json();
    })
    .then(data => {
        showAlert('Schedule entry created successfully', 'success');
        
        // Refresh the schedule table
        const startDate = getStartOfWeek(new Date(scheduleData.schedule_date));
        loadWeeklySchedule(startDate);
        
        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('addScheduleModal'));
        modal.hide();
    })
    .catch(error => {
        showAlert('Error creating schedule entry: ' + error.message, 'danger');
    });
}

function generateSchedule(scheduleData) {
    // Submit the schedule generation request to the API
    fetch('/api/staff/schedule/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(scheduleData),
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to generate schedule');
        }
        return response.json();
    })
    .then(data => {
        showAlert(`Schedule generated successfully: ${data.message}`, 'success');
        
        // Refresh the schedule table
        const startDate = getStartOfWeek(new Date(scheduleData.start_date));
        loadWeeklySchedule(startDate);
        
        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('generateScheduleModal'));
        modal.hide();
    })
    .catch(error => {
        showAlert('Error generating schedule: ' + error.message, 'danger');
    });
}

function loadScheduleForEdit(scheduleId) {
    // Fetch schedule data from the API
    fetch(`/api/staff/schedule/${scheduleId}`)
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to load schedule details');
        }
        return response.json();
    })
    .then(schedule => {
        // Populate the edit form with schedule data
        document.getElementById('edit-schedule-id').value = schedule.id;
        document.getElementById('edit-schedule-employee').value = schedule.employee_id;
        document.getElementById('edit-schedule-date').value = schedule.schedule_date;
        document.getElementById('edit-schedule-shift').value = schedule.shift;
        document.getElementById('edit-schedule-notes').value = schedule.notes || '';
        
        // Load employees for the dropdown if needed
        loadEmployeesForEdit();
    })
    .catch(error => {
        showAlert('Error loading schedule details: ' + error.message, 'danger');
    });
}

function updateScheduleEntry(scheduleData) {
    // Submit the updated schedule data to the API
    fetch(`/api/staff/schedule/${scheduleData.schedule_id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(scheduleData),
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update schedule entry');
        }
        return response.json();
    })
    .then(data => {
        showAlert('Schedule entry updated successfully', 'success');
        
        // Refresh the schedule table
        const startDate = getStartOfWeek(new Date(scheduleData.schedule_date));
        loadWeeklySchedule(startDate);
        
        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('editScheduleModal'));
        modal.hide();
    })
    .catch(error => {
        showAlert('Error updating schedule entry: ' + error.message, 'danger');
    });
}

function deleteScheduleEntry(scheduleId) {
    if (!confirm('Are you sure you want to delete this schedule entry?')) {
        return;
    }
    
    // Submit the delete request to the API
    fetch(`/api/staff/schedule/${scheduleId}`, {
        method: 'DELETE',
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to delete schedule entry');
        }
        return response.json();
    })
    .then(data => {
        showAlert('Schedule entry deleted successfully', 'success');
        
        // Refresh the schedule table
        const startDate = getCurrentWeekStartDate();
        loadWeeklySchedule(startDate);
    })
    .catch(error => {
        showAlert('Error deleting schedule entry: ' + error.message, 'danger');
    });
}

function loadEmployeesForEdit() {
    try {
        // Only load if dropdown exists
        const dropdown = document.getElementById('edit-schedule-employee');
        if (!dropdown) {
            console.error('Edit schedule employee dropdown not found');
            return;
        }
        
        // Only load if not already loaded
        if (dropdown.options.length <= 1) {
            fetch('/api/staff/attendants')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(employees => {
                if (!Array.isArray(employees)) {
                    console.error('Employees data is not an array');
                    return;
                }
                
                // Filter to active employees
                const activeEmployees = employees.filter(emp => emp && emp.active);
                
                try {
                    // Clear existing options except the first one
                    while (dropdown.options.length > 1) {
                        dropdown.remove(1);
                    }
                    
                    // Add employee options
                    activeEmployees.forEach(employee => {
                        if (!employee || !employee.employee_id || !employee.name) return;
                        
                        const option = document.createElement('option');
                        option.value = employee.employee_id;
                        option.textContent = `${employee.name} (${employee.employee_id})`;
                        dropdown.appendChild(option);
                    });
                } catch (domError) {
                    console.error('Error manipulating dropdown:', domError);
                }
            })
            .catch(error => {
                console.error('Error loading employees for edit:', error);
            });
        }
    } catch (error) {
        console.error('Exception in loadEmployeesForEdit:', error);
    }
}

function getStartOfWeek(date) {
    const startOfWeek = new Date(date);
    const day = startOfWeek.getDay();
    const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Sunday
    startOfWeek.setDate(diff);
    startOfWeek.setHours(0, 0, 0, 0);
    return startOfWeek;
}

// Initialize the schedule page when the tab is shown
const scheduleTab = document.getElementById('schedule-tab');
if (scheduleTab) {
    scheduleTab.addEventListener('shown.bs.tab', function (e) {
        const startDate = getStartOfWeek(new Date());
        loadWeeklySchedule(startDate);
        
        // Load employee data for the dropdowns
        loadEmployees();
    });
}

// Add event listeners for schedule action buttons
document.addEventListener('DOMContentLoaded', function() {
    // Add Schedule form submission
    const addScheduleForm = document.getElementById('add-schedule-form');
    if (addScheduleForm) {
        addScheduleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const form = this;
            const scheduleData = {
                employee_id: form.elements['schedule-employee'].value,
                schedule_date: form.elements['schedule-date'].value,
                shift: form.elements['schedule-shift'].value,
                branch_id: "1", // This would be dynamic in a real app
                created_by: "admin", // This would be the current user
                status: "scheduled",
                notes: form.elements['schedule-notes'].value
            };
            
            createScheduleEntry(scheduleData);
        });
    }
    
    // Generate Schedule form submission
    const generateScheduleForm = document.getElementById('generate-schedule-form');
    if (generateScheduleForm) {
        generateScheduleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const form = this;
            const scheduleData = {
                start_date: form.elements['generate-start-date'].value,
                end_date: form.elements['generate-end-date'].value,
                branch_id: "1", // This would be dynamic in a real app
                created_by: "admin" // This would be the current user
            };
            
            generateSchedule(scheduleData);
        });
    }
    
    // Edit Schedule form submission
    const editScheduleForm = document.getElementById('edit-schedule-form');
    if (editScheduleForm) {
        editScheduleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const form = this;
            const scheduleData = {
                schedule_id: form.elements['edit-schedule-id'].value,
                employee_id: form.elements['edit-schedule-employee'].value,
                schedule_date: form.elements['edit-schedule-date'].value,
                shift: form.elements['edit-schedule-shift'].value,
                notes: form.elements['edit-schedule-notes'].value,
                branch_id: "1", // This would be dynamic in a real app
                status: "scheduled"
            };
            
            updateScheduleEntry(scheduleData);
        });
    }
    
    // Add event delegation for edit and delete buttons
    document.addEventListener('click', function(e) {
        // Edit schedule button
        if (e.target.closest('.edit-schedule-btn')) {
            const button = e.target.closest('.edit-schedule-btn');
            const scheduleId = button.getAttribute('data-schedule-id');
            loadScheduleForEdit(scheduleId);
        }
        
        // Delete schedule button
        if (e.target.closest('.delete-schedule-btn')) {
            const button = e.target.closest('.delete-schedule-btn');
            const scheduleId = button.getAttribute('data-schedule-id');
            deleteScheduleEntry(scheduleId);
        }
    });
});
</script>

<!-- Add Schedule Modal -->
<div class="modal fade" id="addScheduleModal" tabindex="-1" aria-labelledby="addScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addScheduleModalLabel">Add Schedule Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="add-schedule-form">
                    <div class="mb-3">
                        <label for="schedule-employee" class="form-label">Employee</label>
                        <select class="form-select" id="schedule-employee" name="employee_id" required>
                            <option value="">Select Employee</option>
                            <!-- Employees will be loaded here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="schedule-date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="schedule-date" name="schedule_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="schedule-shift" class="form-label">Shift</label>
                        <select class="form-select" id="schedule-shift" name="shift" required>
                            <option value="morning">Morning (6 AM - 2 PM)</option>
                            <option value="afternoon">Afternoon (2 PM - 10 PM)</option>
                            <option value="night">Night (10 PM - 6 AM)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="schedule-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="schedule-notes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="add-schedule-form" class="btn btn-primary">Save Schedule</button>
            </div>
        </div>
    </div>
</div>

<!-- Generate Schedule Modal -->
<div class="modal fade" id="generateScheduleModal" tabindex="-1" aria-labelledby="generateScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateScheduleModalLabel">Auto-Generate Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">
                    Generate a schedule automatically based on staff roles:
                    <ul>
                        <li>At least 1 senior manager per day (morning shift preferred)</li>
                        <li>At least 1 manager per shift</li>
                        <li>Pumpmen distributed across shifts based on total count</li>
                    </ul>
                </p>
                <form id="generate-schedule-form">
                    <div class="mb-3">
                        <label for="generate-start-date" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="generate-start-date" name="start_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="generate-end-date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="generate-end-date" name="end_date" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="generate-schedule-form" class="btn btn-success">Generate Schedule</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editScheduleModalLabel">Edit Schedule Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-schedule-form">
                    <input type="hidden" id="edit-schedule-id" name="schedule_id">
                    <div class="mb-3">
                        <label for="edit-schedule-employee" class="form-label">Employee</label>
                        <select class="form-select" id="edit-schedule-employee" name="employee_id" required>
                            <option value="">Select Employee</option>
                            <!-- Employees will be loaded here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-schedule-date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="edit-schedule-date" name="schedule_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-schedule-shift" class="form-label">Shift</label>
                        <select class="form-select" id="edit-schedule-shift" name="shift" required>
                            <option value="morning">Morning (6 AM - 2 PM)</option>
                            <option value="afternoon">Afternoon (2 PM - 10 PM)</option>
                            <option value="night">Night (10 PM - 6 AM)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-schedule-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="edit-schedule-notes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="edit-schedule-form" class="btn btn-primary">Update Schedule</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}